(node:20116) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
  console.log
    [2026-02-18T12:12:24.634Z] DEBUG http_request {"requestId":"8b12d7a1-da1e-4ee5-add6-ced31aba3d1d","method":"POST","path":"/api/auth/register","status":201,"elapsedMs":27}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.665Z] DEBUG http_request {"requestId":"d58db0d6-80be-47ca-a931-e9ecdb1a591b","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.677Z] DEBUG http_request {"requestId":"777841a4-18ec-4203-b0f0-1d2761776e88","method":"POST","path":"/api/auth/login","status":429,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.688Z] DEBUG http_request {"requestId":"142697a1-2a49-4a57-a9f7-72346d6c9b38","method":"POST","path":"/api/auth/login","status":429,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.704Z] DEBUG http_request {"requestId":"19f5ee76-4bda-49d8-809f-f84d2eeeb286","method":"POST","path":"/api/products","status":401,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.724Z] DEBUG http_request {"requestId":"8424721f-9a6d-4429-9761-8c808abc4379","method":"POST","path":"/api/products","status":403,"elapsedMs":5}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.753Z] DEBUG http_request {"requestId":"cd744aa2-1006-4e41-8754-70427a707396","method":"POST","path":"/api/products","status":201,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.770Z] DEBUG http_request {"requestId":"3d0bd6b8-cc2e-4340-b601-bf22b43331e4","method":"POST","path":"/api/leads","status":400,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.787Z] DEBUG http_request {"requestId":"ae64c870-a1db-491d-9c44-b94c30154566","method":"POST","path":"/api/cart/items","status":400,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.828Z] DEBUG http_request {"requestId":"814a0890-a357-471e-a61c-b675d5aa3dd6","method":"POST","path":"/api/cart/items","status":400,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.842Z] DEBUG http_request {"requestId":"03288c8b-ef65-499c-91c2-8c1627a4e0c2","method":"PATCH","path":"/api/cart/items/item-1","status":400,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.855Z] DEBUG http_request {"requestId":"54fed5d4-684f-4e4f-b27d-b6d7c1503e6e","method":"DELETE","path":"/api/cart/items/item-1","status":400,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.871Z] DEBUG http_request {"requestId":"85eff213-1a08-48ee-9097-6872ad2d69dd","method":"POST","path":"/api/orders","status":403,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.887Z] DEBUG http_request {"requestId":"b20449c2-f012-4f72-a63e-81523d6dcf0b","method":"POST","path":"/api/orders","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.901Z] DEBUG http_request {"requestId":"6af4d6be-a157-4674-8228-a3e9bc7bd428","method":"POST","path":"/api/orders","status":201,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.918Z] DEBUG http_request {"requestId":"1b117c0a-87d7-46ea-944e-294da774ab3d","method":"POST","path":"/api/orders","status":403,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.935Z] DEBUG http_request {"requestId":"cc9dc02b-fa63-4401-bd2f-d787b87fa25f","method":"POST","path":"/api/payments/create-intent","status":201,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.956Z] DEBUG http_request {"requestId":"34db1782-320d-44e6-9f5a-96b1b8acb5b5","method":"POST","path":"/api/payments/create-intent","status":201,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.961Z] DEBUG http_request {"requestId":"995588f1-929c-4d72-bab3-623d8b7253a1","method":"POST","path":"/api/payments/create-intent","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:24.998Z] INFO webhook_received {"provider":"stripe","correlationId":"b5da0e48-3c4a-4b64-a42b-5a03aa15022b","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.002Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_123","eventType":"payment_intent.succeeded","correlationId":"b5da0e48-3c4a-4b64-a42b-5a03aa15022b"}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.004Z] DEBUG http_request {"requestId":"b5da0e48-3c4a-4b64-a42b-5a03aa15022b","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":7}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.017Z] INFO webhook_received {"provider":"stripe","correlationId":"481d8845-5bd1-4fd5-a223-60196d3f2b49","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:25.018Z] WARN stripe_webhook_signature_validation_failed {"reason":"Stripe signature timestamp outside tolerance","correlationId":"481d8845-5bd1-4fd5-a223-60196d3f2b49"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:110:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:25.025Z] DEBUG http_request {"requestId":"481d8845-5bd1-4fd5-a223-60196d3f2b49","method":"POST","path":"/api/webhooks/stripe","status":400,"elapsedMs":9}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.038Z] INFO webhook_received {"provider":"stripe","correlationId":"546d5965-413e-49c2-9925-a58c2a8c33a8","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.039Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_replay_123","eventType":"payment_intent.succeeded","correlationId":"546d5965-413e-49c2-9925-a58c2a8c33a8"}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.042Z] DEBUG http_request {"requestId":"546d5965-413e-49c2-9925-a58c2a8c33a8","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.051Z] INFO webhook_received {"provider":"stripe","correlationId":"af0790d0-e944-4dcc-abdd-8b6d853ada68","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.053Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_replay_123","eventType":"payment_intent.succeeded","correlationId":"af0790d0-e944-4dcc-abdd-8b6d853ada68"}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:25.054Z] WARN webhook_replay_detected {"provider":"stripe","eventId":"evt_replay_123","orderId":"00000000-0000-0000-0000-000000000777","reason":"replay","correlationId":"af0790d0-e944-4dcc-abdd-8b6d853ada68"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:65:12)
      at src/routes/webhooks.routes.js:133:28

  console.log
    [2026-02-18T12:12:25.056Z] DEBUG http_request {"requestId":"af0790d0-e944-4dcc-abdd-8b6d853ada68","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":5}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.068Z] INFO webhook_received {"provider":"paypal","correlationId":"e045050d-3efa-4725-ae21-9777add875ff","payloadSize":234}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.071Z] DEBUG http_request {"requestId":"e045050d-3efa-4725-ae21-9777add875ff","method":"POST","path":"/api/webhooks/paypal","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.084Z] INFO webhook_received {"provider":"paypal","correlationId":"dcdbce75-04c1-4ce4-8bf8-88ac5dd577db","payloadSize":236}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:25.085Z] WARN paypal_webhook_signature_validation_failed {"reason":"FAILURE","verificationStatus":"FAILURE","correlationId":"dcdbce75-04c1-4ce4-8bf8-88ac5dd577db"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:252:14)

  console.log
    [2026-02-18T12:12:25.087Z] DEBUG http_request {"requestId":"dcdbce75-04c1-4ce4-8bf8-88ac5dd577db","method":"POST","path":"/api/webhooks/paypal","status":400,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.117Z] INFO webhook_received {"provider":"paypal","correlationId":"394fcc4a-87ac-4575-aef9-1ee27a24c302","payloadSize":235}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.119Z] DEBUG http_request {"requestId":"394fcc4a-87ac-4575-aef9-1ee27a24c302","method":"POST","path":"/api/webhooks/paypal","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.129Z] INFO webhook_received {"provider":"paypal","correlationId":"5fa74d79-8cd9-49a6-bd72-60b56b138de9","payloadSize":235}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:25.130Z] WARN webhook_replay_detected {"provider":"paypal","eventId":"paypal_evt_replay_1","orderId":"00000000-0000-0000-0000-000000000777","reason":"replay","correlationId":"5fa74d79-8cd9-49a6-bd72-60b56b138de9"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:65:12)
      at src/routes/webhooks.routes.js:237:28

  console.log
    [2026-02-18T12:12:25.132Z] DEBUG http_request {"requestId":"5fa74d79-8cd9-49a6-bd72-60b56b138de9","method":"POST","path":"/api/webhooks/paypal","status":200,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.145Z] DEBUG http_request {"requestId":"d2fa0d9f-b8be-4493-bed2-99d2d307cb5f","method":"POST","path":"/api/orders","status":400,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.156Z] DEBUG http_request {"requestId":"f158a26f-6890-4c1a-91af-f5ff89b3cd6c","method":"POST","path":"/api/orders","status":400,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.167Z] DEBUG http_request {"requestId":"f1807623-6aed-489c-869b-894cd161bd06","method":"GET","path":"/api/orders/not-uuid","status":400,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.179Z] DEBUG http_request {"requestId":"fc49f34d-843e-4451-9f7a-f3ea51c4a1c9","method":"GET","path":"/api/leads?page=1&limit=10","status":403,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.192Z] DEBUG http_request {"requestId":"0facd89d-784a-46ee-b82c-c2d1ef9e8134","method":"POST","path":"/api/analytics/events","status":400,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.204Z] DEBUG http_request {"requestId":"2caf2ed3-abc2-4324-ae6e-bbcc2c7e0185","method":"GET","path":"/api/analytics/events?eventType=view","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

PASS tests/integration/runtime.routes.test.js (141 MB heap size)
  runtime business routes
    Ã”ÃªÃœ mounts auth register (165 ms)
    Ã”ÃªÃœ returns 429 on strict auth rate limiting (38 ms)
    Ã”ÃªÃœ products create returns 401 without token (17 ms)
    Ã”ÃªÃœ products create returns 403 for non-admin (19 ms)
    Ã”ÃªÃœ products create returns 201 for admin (27 ms)
    Ã”ÃªÃœ leads create returns 400 for unknown fields (18 ms)
    Ã”ÃªÃœ cart add item returns 400 for unknown fields (16 ms)
    Ã”ÃªÃœ cart add item rejects client-provided userId (41 ms)
    Ã”ÃªÃœ cart route mounted and validates params/body (15 ms)
    Ã”ÃªÃœ cart delete uses strict validation for payload and params (12 ms)
    Ã”ÃªÃœ orders create returns 403 for admin role (15 ms)
    Ã”ÃªÃœ orders create returns 200 for guest when replayed (16 ms)
    Ã”ÃªÃœ orders create returns 201 for customer role (15 ms)
    Ã”ÃªÃœ orders create returns 403 for tampered guest claims (16 ms)
    Ã”ÃªÃœ payments create-intent computes amount from DB and returns metadata (18 ms)
    Ã”ÃªÃœ payments create-intent is idempotent for concurrent multi-client retries (29 ms)
    Ã”ÃªÃœ stripe webhook verifies signature and calls atomic payment finalization (39 ms)
    Ã”ÃªÃœ stripe webhook rejects invalid signature (20 ms)
    Ã”ÃªÃœ stripe webhook replay keeps idempotent behavior (31 ms)
    Ã”ÃªÃœ paypal webhook with verified signature is processed (14 ms)
    Ã”ÃªÃœ paypal webhook rejects invalid signature (16 ms)
    Ã”ÃªÃœ paypal webhook replay keeps idempotent behavior (44 ms)
    Ã”ÃªÃœ orders create rejects any userId field from client payload (13 ms)
    Ã”ÃªÃœ orders create returns 400 for unknown fields (strict zod) (11 ms)
    Ã”ÃªÃœ orders route validates uuid params (11 ms)
    Ã”ÃªÃœ leads admin listing is role-protected (12 ms)
    Ã”ÃªÃœ analytics events reject client-provided userId (14 ms)
    Ã”ÃªÃœ analytics listing mounted and protected (12 ms)

  console.log
    [2026-02-18T12:12:25.542Z] DEBUG http_request {"requestId":"e1dd1dc2-2fb7-4e83-9a9c-1f51d2632448","method":"POST","path":"/api/auth/forgot","status":200,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.560Z] DEBUG http_request {"requestId":"bf4d7ae2-bac0-45ef-bb9f-62be59ae9975","method":"POST","path":"/api/auth/forgot","status":400,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.573Z] DEBUG http_request {"requestId":"ff70d91a-60d7-473c-9175-cf6b204c7c73","method":"POST","path":"/api/auth/forgot","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.583Z] DEBUG http_request {"requestId":"a63f0627-69b2-4697-a144-3f3f36c3a53d","method":"POST","path":"/api/auth/forgot","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.593Z] DEBUG http_request {"requestId":"4378c344-3d58-4629-ac5d-8ab43582a05a","method":"POST","path":"/api/auth/forgot","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.605Z] DEBUG http_request {"requestId":"462a91a1-c9fb-493a-a0d8-0680536be49d","method":"POST","path":"/api/auth/forgot","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.614Z] DEBUG http_request {"requestId":"22a335a2-59a1-4c88-bc63-43d09cd93eec","method":"POST","path":"/api/auth/forgot","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.636Z] DEBUG http_request {"requestId":"82aa481e-0e97-448b-b109-f898ec356709","method":"POST","path":"/api/auth/forgot","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.644Z] DEBUG http_request {"requestId":"40b06857-8039-4150-a085-9f61ae1a7829","method":"POST","path":"/api/auth/forgot","status":429,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.653Z] DEBUG http_request {"requestId":"ea1b8f19-6861-46d4-a77f-a5fc74b08f32","method":"POST","path":"/api/auth/reset","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.662Z] DEBUG http_request {"requestId":"e88dfacf-3e26-4126-950b-6e7ee587950d","method":"POST","path":"/api/auth/reset","status":400,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.671Z] DEBUG http_request {"requestId":"4c8cc87f-394d-45f7-8ee4-460530009c40","method":"POST","path":"/api/auth/reset","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.679Z] DEBUG http_request {"requestId":"b35f43eb-1ac6-4323-b85e-2990a3318b8c","method":"POST","path":"/api/auth/reset","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.686Z] DEBUG http_request {"requestId":"a19c3a45-1829-4071-9c31-ccb236b4c819","method":"POST","path":"/api/auth/reset","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.693Z] DEBUG http_request {"requestId":"7ed63e03-d943-4efe-bc78-e7365434a1fa","method":"POST","path":"/api/auth/reset","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.700Z] DEBUG http_request {"requestId":"e0312192-b5d6-4c6a-8dd1-3173faa9949b","method":"POST","path":"/api/auth/reset","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.718Z] DEBUG http_request {"requestId":"c23140d0-96c9-41c1-9855-39dc7115a43b","method":"POST","path":"/api/auth/reset","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.725Z] DEBUG http_request {"requestId":"8609fd5b-f8fa-4762-b181-21d5952d8b5d","method":"POST","path":"/api/auth/reset","status":429,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.736Z] DEBUG http_request {"requestId":"091fc5bd-6dc7-4b2c-9bc9-0fb4544bc8a9","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.746Z] DEBUG http_request {"requestId":"3e6a9c71-e226-4528-95e3-10d4d2524c83","method":"POST","path":"/api/auth/refresh","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.755Z] DEBUG http_request {"requestId":"3a2f40d6-333e-4ff2-8d1c-b1fb3b75a1dd","method":"POST","path":"/api/auth/refresh","status":400,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.764Z] DEBUG http_request {"requestId":"9fcd9965-541c-43e9-ae51-e55a413097e7","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.773Z] DEBUG http_request {"requestId":"8549854d-423f-4405-b7d7-04cc6730448a","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.782Z] DEBUG http_request {"requestId":"7a5a3945-5176-4c1e-82e5-df17725ae338","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.792Z] DEBUG http_request {"requestId":"5686d267-6027-48e7-8a7f-83341e3eb884","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.800Z] DEBUG http_request {"requestId":"bbb45aee-e11a-40f3-a722-de3ee1dc0d92","method":"POST","path":"/api/auth/refresh","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.808Z] DEBUG http_request {"requestId":"d0f1f207-8cd1-49c1-abd7-3d8164fab7f0","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.815Z] DEBUG http_request {"requestId":"525d5fa5-eb20-4414-9d97-f87c3c7c1324","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.825Z] DEBUG http_request {"requestId":"f279c13b-a321-46b8-9534-9fd3ac682263","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.832Z] DEBUG http_request {"requestId":"4bbf738c-2b0c-485a-aa7a-2fd383f172c0","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.841Z] DEBUG http_request {"requestId":"0d088100-e53c-4c60-b1b0-e7335c6f331f","method":"POST","path":"/api/auth/refresh","status":429,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:25.858Z] DEBUG http_request {"requestId":"8c0af703-0cf2-4392-93ad-3ea2d5106c06","method":"POST","path":"/api/auth/refresh","status":429,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

PASS tests/integration/auth.runtime-sensitive.test.js (151 MB heap size)
  sensitive auth runtime endpoints
    Ã”ÃªÃœ POST /api/auth/forgot returns 200 on valid payload (30 ms)
    Ã”ÃªÃœ POST /api/auth/forgot returns 400 on invalid payload (15 ms)
    Ã”ÃªÃœ POST /api/auth/forgot returns 429 when strict auth rate limit exceeded (83 ms)
    Ã”ÃªÃœ POST /api/auth/reset returns 200 on valid payload (9 ms)
    Ã”ÃªÃœ POST /api/auth/reset returns 400 on invalid payload (9 ms)
    Ã”ÃªÃœ POST /api/auth/reset returns 429 when strict auth rate limit exceeded (63 ms)
    Ã”ÃªÃœ POST /api/auth/refresh returns 200 on valid refresh token (21 ms)
    Ã”ÃªÃœ POST /api/auth/refresh returns 400 on invalid payload (9 ms)
    Ã”ÃªÃœ POST /api/auth/refresh returns 401 on invalid refresh token (8 ms)
    Ã”ÃªÃœ POST /api/auth/refresh rejects refresh token signed with wrong secret (9 ms)
    Ã”ÃªÃœ POST /api/auth/refresh rejects refresh token with wrong audience (9 ms)
    Ã”ÃªÃœ POST /api/auth/refresh returns 429 when strict auth rate limit exceeded (82 ms)

  console.log
    [2026-02-18T12:12:26.182Z] INFO webhook_received {"provider":"paypal","correlationId":"1b0b1937-0265-45f3-9a09-518806715dd6","payloadSize":298}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.186Z] DEBUG http_request {"requestId":"1b0b1937-0265-45f3-9a09-518806715dd6","method":"POST","path":"/api/webhooks/paypal","status":400,"elapsedMs":6}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.197Z] INFO webhook_received {"provider":"paypal","correlationId":"636f6e08-5455-4a5b-903b-90149b2cbc7a","payloadSize":306}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:26.198Z] ERROR webhook_order_not_found {"provider":"paypal","eventId":"evt_paypal_not_found","orderId":"00000000-0000-0000-0000-000000000111","correlationId":"636f6e08-5455-4a5b-903b-90149b2cbc7a"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/routes/webhooks.routes.js:266:14)

  console.log
    [2026-02-18T12:12:26.200Z] DEBUG http_request {"requestId":"636f6e08-5455-4a5b-903b-90149b2cbc7a","method":"POST","path":"/api/webhooks/paypal","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.209Z] INFO webhook_received {"provider":"paypal","correlationId":"5bd57cc5-643d-4daa-95cc-6db9fea5d839","payloadSize":302}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:26.210Z] ERROR webhook_order_state_incompatible {"provider":"paypal","eventId":"evt_paypal_state","orderId":"00000000-0000-0000-0000-000000000111","status":"cancelled","correlationId":"5bd57cc5-643d-4daa-95cc-6db9fea5d839"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/routes/webhooks.routes.js:276:14)

  console.log
    [2026-02-18T12:12:26.212Z] DEBUG http_request {"requestId":"5bd57cc5-643d-4daa-95cc-6db9fea5d839","method":"POST","path":"/api/webhooks/paypal","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.221Z] INFO webhook_received {"provider":"paypal","correlationId":"d386f236-d6ef-4474-a078-47f39b0af1b9","payloadSize":303}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:26.222Z] ERROR webhook_amount_mismatch {"provider":"paypal","eventId":"evt_paypal_amount","orderId":"00000000-0000-0000-0000-000000000111","expectedMinor":1200,"receivedMinor":1100,"correlationId":"d386f236-d6ef-4474-a078-47f39b0af1b9"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/routes/webhooks.routes.js:298:14)

  console.log
    [2026-02-18T12:12:26.224Z] DEBUG http_request {"requestId":"d386f236-d6ef-4474-a078-47f39b0af1b9","method":"POST","path":"/api/webhooks/paypal","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.233Z] INFO webhook_received {"provider":"paypal","correlationId":"499d726d-220d-43d9-a507-5e336e9225d4","payloadSize":305}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:26.234Z] ERROR webhook_currency_mismatch {"provider":"paypal","eventId":"evt_paypal_currency","orderId":"00000000-0000-0000-0000-000000000111","expectedCurrency":"EUR","receivedCurrency":"USD","correlationId":"499d726d-220d-43d9-a507-5e336e9225d4"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/routes/webhooks.routes.js:310:14)

  console.log
    [2026-02-18T12:12:26.236Z] DEBUG http_request {"requestId":"499d726d-220d-43d9-a507-5e336e9225d4","method":"POST","path":"/api/webhooks/paypal","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.246Z] INFO webhook_received {"provider":"paypal","correlationId":"444a7865-5ba0-4806-a658-56172d8b9b69","payloadSize":301}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.248Z] DEBUG http_request {"requestId":"444a7865-5ba0-4806-a658-56172d8b9b69","method":"POST","path":"/api/webhooks/paypal","status":400,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.256Z] INFO webhook_received {"provider":"paypal","correlationId":"76d53540-b238-449f-b3e7-22bc0b5e5c49","payloadSize":303}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:26.257Z] WARN webhook_replay_detected {"provider":"paypal","eventId":"evt_paypal_replay","orderId":"00000000-0000-0000-0000-000000000111","reason":"replay","correlationId":"76d53540-b238-449f-b3e7-22bc0b5e5c49"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:65:12)
      at src/routes/webhooks.routes.js:237:28

  console.log
    [2026-02-18T12:12:26.259Z] DEBUG http_request {"requestId":"76d53540-b238-449f-b3e7-22bc0b5e5c49","method":"POST","path":"/api/webhooks/paypal","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.268Z] INFO webhook_received {"provider":"paypal","correlationId":"7c82ec5f-dcab-4103-b7c1-d6cba3ddda28","payloadSize":302}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:26.269Z] WARN webhook_replay_detected {"provider":"paypal","eventId":"evt_paypal_badid","orderId":"00000000-0000-0000-0000-000000000111","reason":"invalid_event_id","correlationId":"7c82ec5f-dcab-4103-b7c1-d6cba3ddda28"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:65:12)
      at src/routes/webhooks.routes.js:237:28

  console.log
    [2026-02-18T12:12:26.271Z] DEBUG http_request {"requestId":"7c82ec5f-dcab-4103-b7c1-d6cba3ddda28","method":"POST","path":"/api/webhooks/paypal","status":400,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.289Z] INFO webhook_received {"provider":"paypal","correlationId":"6976d47a-5230-4b47-b97a-b08857a5fd60","payloadSize":304}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:26.290Z] WARN paypal_webhook_signature_validation_failed {"reason":"FAILURE","verificationStatus":"FAILURE","correlationId":"6976d47a-5230-4b47-b97a-b08857a5fd60"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:252:14)

  console.log
    [2026-02-18T12:12:26.293Z] DEBUG http_request {"requestId":"6976d47a-5230-4b47-b97a-b08857a5fd60","method":"POST","path":"/api/webhooks/paypal","status":400,"elapsedMs":5}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:26.320Z] WARN api_error {"code":"INTERNAL_ERROR","message":"Webhook payload must be raw buffer","requestId":"5648ee57-e1d6-40cf-9a7a-a4939d0a73f1","details":[],"name":"Error","stack":"Error: Webhook payload must be raw buffer\n    at parseRawJsonBody (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\routes\\webhooks.routes.js:28:19)\n    at parseRawJsonBody (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\routes\\webhooks.routes.js:228:27)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at router.handle (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:175:3)\n    at router (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:47:12)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\middlewares\\rateLimit.js:89:14)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at Immediate.next (node_modules/express/lib/router/index.js:280:10)
      at Immediate._onImmediate (node_modules/express/lib/router/index.js:646:15)

  console.log
    [2026-02-18T12:12:26.324Z] DEBUG http_request {"requestId":"5648ee57-e1d6-40cf-9a7a-a4939d0a73f1","method":"POST","path":"/api/webhooks/paypal","status":400,"elapsedMs":20}

      at log (src/utils/logger.js:44:11)

PASS tests/routes/webhooks.paypal.test.js (91 MB heap size)
  paypal webhook route branches
    Ã”ÃªÃœ rejects metadata order mismatch (30 ms)
    Ã”ÃªÃœ ignores order not found (12 ms)
    Ã”ÃªÃœ ignores incompatible order state (12 ms)
    Ã”ÃªÃœ ignores amount mismatch (13 ms)
    Ã”ÃªÃœ ignores currency mismatch (11 ms)
    Ã”ÃªÃœ rejects unexpected capture status (11 ms)
    Ã”ÃªÃœ replay idempotency response (12 ms)
    Ã”ÃªÃœ invalid event id response (10 ms)
    Ã”ÃªÃœ signature failure (24 ms)
    Ã”ÃªÃœ non-buffer body parse error is mapped (40 ms)

  console.log
    [2026-02-18T12:12:26.680Z] DEBUG http_request {"requestId":"22f9d772-7ff1-43ec-a1e9-362f10516382","method":"GET","path":"/api/admin/health","status":401,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.692Z] DEBUG http_request {"requestId":"633b5daa-836c-4a18-92cf-a162f1825b18","method":"GET","path":"/api/admin/health","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:26.709Z] WARN auth_failure {"reason":"token verification error","detail":"Invalid access token","requestId":"0c8bebdd-83ce-4396-bb1b-ce9f7bee0d51"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/middlewares/authenticate.js:13:10)
      at logAuthenticationFailure (src/middlewares/authenticate.js:47:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:26.712Z] DEBUG http_request {"requestId":"0c8bebdd-83ce-4396-bb1b-ce9f7bee0d51","method":"GET","path":"/api/admin/health","status":401,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.723Z] DEBUG http_request {"requestId":"61c74b31-b14a-42dc-9ed8-4155356d83f4","method":"GET","path":"/api/admin/health","status":403,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.733Z] DEBUG http_request {"requestId":"2736124b-414f-4d4f-a4ca-35b05e05a0df","method":"GET","path":"/api/admin/health","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.742Z] DEBUG http_request {"requestId":"25db070c-b8b1-4aa1-9d3e-367deab6a0fd","method":"GET","path":"/api/admin/health","status":403,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:26.749Z] WARN auth_failure {"reason":"token verification error","detail":"Invalid access token","requestId":"e42fc149-e1e5-4096-90cd-69a679787ce5"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/middlewares/authenticate.js:13:10)
      at logAuthenticationFailure (src/middlewares/authenticate.js:47:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:26.752Z] DEBUG http_request {"requestId":"e42fc149-e1e5-4096-90cd-69a679787ce5","method":"GET","path":"/api/admin/health","status":401,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:26.760Z] WARN auth_failure {"reason":"token verification error","detail":"Invalid access token","requestId":"12e09909-cc63-4850-befe-f7d30dc18741"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/middlewares/authenticate.js:13:10)
      at logAuthenticationFailure (src/middlewares/authenticate.js:47:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:26.762Z] DEBUG http_request {"requestId":"12e09909-cc63-4850-befe-f7d30dc18741","method":"GET","path":"/api/admin/health","status":401,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:26.772Z] WARN auth_failure {"reason":"token verification error","detail":"Invalid access token","requestId":"bccf116f-ee56-4242-8782-6ffbf6c08c89"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/middlewares/authenticate.js:13:10)
      at logAuthenticationFailure (src/middlewares/authenticate.js:47:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:26.775Z] DEBUG http_request {"requestId":"bccf116f-ee56-4242-8782-6ffbf6c08c89","method":"GET","path":"/api/admin/health","status":401,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:26.784Z] WARN auth_failure {"reason":"token verification error","detail":"Invalid access token","requestId":"dbe6aae1-7e16-4646-b30c-ffa18da96bf7"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/middlewares/authenticate.js:13:10)
      at logAuthenticationFailure (src/middlewares/authenticate.js:47:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:26.787Z] DEBUG http_request {"requestId":"dbe6aae1-7e16-4646-b30c-ffa18da96bf7","method":"GET","path":"/api/admin/health","status":401,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:26.805Z] WARN auth_failure {"reason":"token payload missing subject"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/middlewares/authenticate.js:13:10)
      at logAuthenticationFailure (src/middlewares/authenticate.js:57:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:26.809Z] DEBUG http_request {"requestId":"776c34c8-ce49-4169-99cd-5e256f0f0ea5","method":"GET","path":"/api/admin/health","status":401,"elapsedMs":5}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.820Z] DEBUG http_request {"requestId":"789f7f27-b5bb-4baf-a781-a9576bc80f66","method":"GET","path":"/api/admin/health","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.831Z] DEBUG http_request {"requestId":"7eb79088-7269-4783-8269-308dfab74f5f","method":"GET","path":"/api/health","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.841Z] DEBUG http_request {"requestId":"abc59823-c109-414d-95cc-950b0a305c90","method":"GET","path":"/api/admin/audit-log","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.851Z] DEBUG http_request {"requestId":"bab4ac09-ec2b-40fd-af31-bab28a500d5a","method":"GET","path":"/api/admin/reports","status":403,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.861Z] DEBUG http_request {"requestId":"c098f77d-3462-46d6-a549-ec1eca29ab8d","method":"GET","path":"/api/admin/health","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:26.870Z] DEBUG http_request {"requestId":"ecf3b3a6-74fc-4f56-a601-fada7921cce8","method":"GET","path":"/api/admin/health","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:26.879Z] ERROR http_request_failed {"requestId":"c9a28730-039b-4613-9979-c38be45c1508","method":"GET","path":"/api/admin/health","status":500,"elapsedMs":1}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

  console.error
    [2026-02-18T12:12:26.888Z] ERROR http_request_failed {"requestId":"c3791a9d-5278-4e2d-a4cc-cf46cc6fcb15","method":"GET","path":"/api/admin/health","status":500,"elapsedMs":1}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

  console.error
    [2026-02-18T12:12:26.899Z] ERROR http_request_failed {"requestId":"584658e0-584d-4fea-bddb-c700c50b4d2a","method":"GET","path":"/api/admin/health","status":500,"elapsedMs":1}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

  console.log
    [2026-02-18T12:12:26.909Z] DEBUG http_request {"requestId":"req-test-123","method":"GET","path":"/api/admin/health","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

PASS tests/admin-routes.auth.test.js (100 MB heap size)
  Admin routes protection (/api/admin)
    Ã”ÃªÃœ 1) sans token -> 401 (25 ms)
    Ã”ÃªÃœ 2) header Authorization mal formâ”œÂ® -> 401 (9 ms)
    Ã”ÃªÃœ 3) token invalide -> 401 (20 ms)
    Ã”ÃªÃœ 4) token valide non-admin -> 403 (11 ms)
    Ã”ÃªÃœ 5) token admin valide -> 200 (10 ms)
    Ã”ÃªÃœ 6) token sans râ”œâ”¤le -> 403 (8 ms)
    Ã”ÃªÃœ 7) token expirâ”œÂ® -> 401 (10 ms)
    Ã”ÃªÃœ 7b) token sans issuer/audience (legacy) -> 401 (11 ms)
    Ã”ÃªÃœ 8) token avec mauvaise audience -> 401 (12 ms)
    Ã”ÃªÃœ 8a) token signâ”œÂ® avec le secret refresh -> 401 (11 ms)
    Ã”ÃªÃœ 8b) token avec payload invalide (sans sub/id) -> 401 uniforme (22 ms)
    Ã”ÃªÃœ 9) route admin ne fuit pas les claims auth -> 200 (12 ms)
    Ã”ÃªÃœ route publique de dâ”œÂ®mo reste accessible sans token -> 200 (11 ms)
  Admin example routes strategy (/api/admin/* via mounted example router)
    Ã”ÃªÃœ ops autorisâ”œÂ® sur /api/admin/audit-log -> 200 (10 ms)
    Ã”ÃªÃœ ops refusâ”œÂ® sur /api/admin/reports -> 403 (9 ms)
  Role normalization policy
    Ã”ÃªÃœ râ”œâ”¤le " admin " est acceptâ”œÂ® pour une route admin stricte -> 200 (10 ms)
    Ã”ÃªÃœ râ”œâ”¤le "Admin" est acceptâ”œÂ® (case-insensitive) -> 200 (8 ms)
  JWT misconfiguration handling
    Ã”ÃªÃœ secret absent -> 500 (10 ms)
    Ã”ÃªÃœ issuer sans audience -> 500 (10 ms)
    Ã”ÃªÃœ audience sans issuer -> 500 (9 ms)
    Ã”ÃªÃœ request-id entrant est propagâ”œÂ® dans la râ”œÂ®ponse dÃ”Ã‡Ã–erreur (10 ms)
  Auth rate limiter payload consistency
    Ã”ÃªÃœ renvoie le schâ”œÂ®ma standardisâ”œÂ® avec requestId aprâ”œÂ¿s dâ”œÂ®passement du seuil (3 ms)

  console.log
    [2026-02-18T12:12:27.231Z] DEBUG http_request {"requestId":"be2f2700-949e-4bca-abb0-94164d0215eb","method":"POST","path":"/api/payments/create-intent","status":201,"elapsedMs":7}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.243Z] DEBUG http_request {"requestId":"884d901c-019e-4018-b98a-cb488a9a0cc2","method":"POST","path":"/api/payments/create-intent","status":403,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.255Z] DEBUG http_request {"requestId":"b60d3425-7fca-4377-8bdf-371280e47c50","method":"POST","path":"/api/orders","status":201,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.266Z] DEBUG http_request {"requestId":"e6a12f3a-ae8b-4cc5-abc9-3e134ce68538","method":"POST","path":"/api/payments/create-intent","status":201,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.290Z] DEBUG http_request {"requestId":"364a15c9-0625-4ee3-88bd-6073bb31df7d","method":"POST","path":"/api/orders","status":201,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.302Z] DEBUG http_request {"requestId":"4c6248f2-e976-4ad6-b67f-ff3d97ff3721","method":"POST","path":"/api/orders","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.312Z] DEBUG http_request {"requestId":"fcad77cb-f7e2-41c9-9ff5-9c10ee3ec6d6","method":"POST","path":"/api/orders","status":400,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:27.322Z] WARN auth_failure {"reason":"token verification error","detail":"Invalid access token","requestId":"15dbe45d-33bc-417c-b04d-828807bfcaec"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/middlewares/authenticate.js:13:10)
      at logAuthenticationFailure (src/middlewares/authenticate.js:47:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at next (src/middlewares/checkoutIdentity.js:12:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at next (src/validation/strict-validate.middleware.js:13:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:27.325Z] DEBUG http_request {"requestId":"15dbe45d-33bc-417c-b04d-828807bfcaec","method":"POST","path":"/api/orders","status":401,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.335Z] DEBUG http_request {"requestId":"53ce770d-284b-4343-a0c2-6d7cacd52d4b","method":"POST","path":"/api/orders","status":400,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:27.354Z] WARN api_error {"code":"INSUFFICIENT_STOCK","message":"Insufficient stock for product","requestId":"3e30af51-cabb-47c0-84e4-7599eabe09bc","details":[],"name":"Error","stack":"Error: Insufficient stock for product\n    at Object.<anonymous> (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\tests\\integration\\guest-checkout.runtime.e2e.test.js:198:21)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at next (node_modules/express/lib/router/route.js:141:14)
      at next (src/routes/orders.routes.js:43:14)

  console.log
    [2026-02-18T12:12:27.357Z] DEBUG http_request {"requestId":"3e30af51-cabb-47c0-84e4-7599eabe09bc","method":"POST","path":"/api/orders","status":400,"elapsedMs":14}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.368Z] DEBUG http_request {"requestId":"7ed1ffa2-ab6b-4d60-b332-34195f915f0b","method":"POST","path":"/api/payments/create-intent","status":201,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.376Z] INFO webhook_received {"provider":"stripe","correlationId":"c0dab1ad-1086-4956-b320-30822320fbee","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.377Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_777","eventType":"payment_intent.succeeded","correlationId":"c0dab1ad-1086-4956-b320-30822320fbee"}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:27.378Z] ERROR webhook_order_not_found {"provider":"stripe","eventId":"evt_777","orderId":"00000000-0000-0000-0000-000000000777","correlationId":"c0dab1ad-1086-4956-b320-30822320fbee"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/routes/webhooks.routes.js:148:14)

  console.log
    [2026-02-18T12:12:27.380Z] DEBUG http_request {"requestId":"c0dab1ad-1086-4956-b320-30822320fbee","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":5}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.397Z] INFO webhook_received {"provider":"stripe","correlationId":"ebbbba9c-e9f6-444c-b417-76acf3bc26b1","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.398Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_777","eventType":"payment_intent.succeeded","correlationId":"ebbbba9c-e9f6-444c-b417-76acf3bc26b1"}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:27.399Z] WARN webhook_replay_detected {"provider":"stripe","eventId":"evt_777","orderId":"00000000-0000-0000-0000-000000000777","reason":"replay","correlationId":"ebbbba9c-e9f6-444c-b417-76acf3bc26b1"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:65:12)
      at src/routes/webhooks.routes.js:133:28

  console.log
    [2026-02-18T12:12:27.401Z] DEBUG http_request {"requestId":"ebbbba9c-e9f6-444c-b417-76acf3bc26b1","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":5}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.410Z] INFO webhook_received {"provider":"paypal","correlationId":"71745d9b-5a74-4c49-bf4c-c59e1dfd118b","payloadSize":222}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:27.411Z] ERROR webhook_order_not_found {"provider":"paypal","eventId":"paypal_evt_1","orderId":"00000000-0000-0000-0000-000000000777","correlationId":"71745d9b-5a74-4c49-bf4c-c59e1dfd118b"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/routes/webhooks.routes.js:266:14)

  console.log
    [2026-02-18T12:12:27.413Z] DEBUG http_request {"requestId":"71745d9b-5a74-4c49-bf4c-c59e1dfd118b","method":"POST","path":"/api/webhooks/paypal","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.419Z] INFO webhook_received {"provider":"paypal","correlationId":"a70c8a82-4c4c-41c5-ad5b-c8fe8acf77e8","payloadSize":222}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:27.420Z] WARN webhook_replay_detected {"provider":"paypal","eventId":"paypal_evt_1","orderId":"00000000-0000-0000-0000-000000000777","reason":"replay","correlationId":"a70c8a82-4c4c-41c5-ad5b-c8fe8acf77e8"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:65:12)
      at src/routes/webhooks.routes.js:237:28

  console.log
    [2026-02-18T12:12:27.421Z] DEBUG http_request {"requestId":"a70c8a82-4c4c-41c5-ad5b-c8fe8acf77e8","method":"POST","path":"/api/webhooks/paypal","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.428Z] INFO webhook_received {"provider":"paypal","correlationId":"9c259283-2576-45a5-abbb-de2ef3835598","payloadSize":232}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:27.429Z] WARN paypal_webhook_signature_validation_failed {"reason":"FAILURE","verificationStatus":"FAILURE","correlationId":"9c259283-2576-45a5-abbb-de2ef3835598"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:252:14)

  console.log
    [2026-02-18T12:12:27.430Z] DEBUG http_request {"requestId":"9c259283-2576-45a5-abbb-de2ef3835598","method":"POST","path":"/api/webhooks/paypal","status":400,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.437Z] INFO webhook_received {"provider":"stripe","correlationId":"fae992f6-124f-4764-8d03-9afe260237e1","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:27.438Z] WARN stripe_webhook_signature_validation_failed {"reason":"No signatures found matching the expected scheme","correlationId":"fae992f6-124f-4764-8d03-9afe260237e1"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:110:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:27.440Z] DEBUG http_request {"requestId":"fae992f6-124f-4764-8d03-9afe260237e1","method":"POST","path":"/api/webhooks/stripe","status":400,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.454Z] DEBUG http_request {"requestId":"e0f4b614-be65-4c58-a5c8-694ac021d4ee","method":"POST","path":"/api/orders","status":201,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:27.464Z] WARN api_error {"code":"INSUFFICIENT_STOCK","message":"Insufficient stock for product","requestId":"5ef58907-74bc-404f-a704-dda5e879bb58","details":[],"name":"Error","stack":"Error: Insufficient stock for product\n    at Object.<anonymous> (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\tests\\integration\\guest-checkout.runtime.e2e.test.js:298:27)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-mock\\build\\index.js:397:39\n    at Object.<anonymous> (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-mock\\build\\index.js:404:13)\n    at Object.mockConstructor [as createIdempotentWithItemsAndUpdateStock] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-mock\\build\\index.js:148:19)\n    at createIdempotentWithItemsAndUpdateStock (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\routes\\orders.routes.js:22:44)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\middlewares\\checkoutCustomerAccess.js:42:10)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\middlewares\\checkoutCustomerAccess.js:27:10)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\middlewares\\authenticate.js:74:10)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\middlewares\\checkoutIdentity.js:12:12)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\strict-validate.middleware.js:13:14)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at router.handle (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:175:3)\n    at router (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:47:12)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\middlewares\\rateLimit.js:89:14)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at next (node_modules/express/lib/router/route.js:141:14)
      at next (src/routes/orders.routes.js:43:14)

  console.log
    [2026-02-18T12:12:27.466Z] DEBUG http_request {"requestId":"5ef58907-74bc-404f-a704-dda5e879bb58","method":"POST","path":"/api/orders","status":400,"elapsedMs":11}

      at log (src/utils/logger.js:44:11)

PASS tests/integration/guest-checkout.runtime.e2e.test.js (164 MB heap size)
  guest checkout runtime e2e
    Ã”ÃªÃœ auth: creates guest user, assigns implicit JWT, customer RBAC only (39 ms)
    Ã”ÃªÃœ orders: success + response contract unchanged (13 ms)
    Ã”ÃªÃœ auth: guest checkout with existing permanent email creates isolated guest identity and guest JWT claims (12 ms)
    Ã”ÃªÃœ orders: guest-created orders always use authenticated guest id (22 ms)
    Ã”ÃªÃœ orders: idempotency replay returns 200 and replayed=true (11 ms)
    Ã”ÃªÃœ orders: invalid payload returns 400 (11 ms)
    Ã”ÃªÃœ orders: auth failure returns 401 for invalid token (12 ms)
    Ã”ÃªÃœ orders: spoofing blocked and stock insuffisant returns 400 (32 ms)
    Ã”ÃªÃœ payments: stripe intent + webhook replay + paypal webhook replay + invalid signature 400 (83 ms)
    Ã”ÃªÃœ concurrence: 2 commandes simultanâ”œÂ®es sur stock limitâ”œÂ® => 1 succâ”œÂ¿s, 1 rollback (28 ms)

  console.log
    [2026-02-18T12:12:27.770Z] DEBUG http_request {"requestId":"1c3ed96d-a0ce-407c-85b9-ca5c909e64e6","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":6}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.780Z] DEBUG http_request {"requestId":"4ea678c4-0351-4095-8929-a74f307e534a","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.789Z] DEBUG http_request {"requestId":"7730ed85-7d8c-4e3b-90ab-0ced60a000a5","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.797Z] DEBUG http_request {"requestId":"ead36725-853a-4a53-b2ed-5db0d020a468","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.808Z] DEBUG http_request {"requestId":"8d1b7ab9-6f16-4bbe-aefe-efb2ad4a82d3","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.816Z] DEBUG http_request {"requestId":"a821cdb4-cbaf-4d67-91e8-6c9158aac716","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.824Z] DEBUG http_request {"requestId":"903dcf8f-9cef-4bfd-84fe-73413d2fc07c","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.835Z] DEBUG http_request {"requestId":"15a41f39-0a5e-4ac4-b761-61e80bd64509","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.853Z] DEBUG http_request {"requestId":"1528252c-7dda-4cda-a37a-405e9571ead5","method":"POST","path":"/api/auth/login","status":429,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.863Z] DEBUG http_request {"requestId":"d9f2425c-1d67-4046-ae9c-2e4414623901","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.872Z] DEBUG http_request {"requestId":"aecf4fb9-9a88-4fdb-9ee2-d608438e9edb","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.879Z] DEBUG http_request {"requestId":"9a36d45d-76c2-497d-8bf7-4935a10e9510","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.888Z] DEBUG http_request {"requestId":"0ce5655b-754d-4f19-8c6a-ed5ac32b2c01","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.895Z] DEBUG http_request {"requestId":"6ab5d41e-d411-4c05-b234-0021f1bc5fe2","method":"POST","path":"/api/auth/login","status":429,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.902Z] DEBUG http_request {"requestId":"9895d8ce-152d-4024-bd36-cd107b7ea295","method":"POST","path":"/api/auth/login","status":429,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.910Z] DEBUG http_request {"requestId":"1366b59e-8890-4704-937c-5d6804392e28","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:27.918Z] DEBUG http_request {"requestId":"14cd7238-056d-456b-a95a-1920611d35af","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

PASS tests/security/bruteforce.test.js (185 MB heap size)
  Bruteforce protection
    Ã”ÃªÃœ 1 to 4 attempts are allowed (52 ms)
    Ã”ÃªÃœ 5th attempt is blocked (56 ms)
    Ã”ÃªÃœ ip stays blocked in same window (48 ms)
    Ã”ÃªÃœ email enumeration does not leak user existence (17 ms)

  console.log
    [2026-02-18T12:12:28.287Z] DEBUG http_request {"requestId":"69bb29c1-0654-4f0a-b451-299bb74e5946","method":"POST","path":"/api/auth/register","status":201,"elapsedMs":8}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:28.316Z] ERROR api_error {"code":"JWT_MISCONFIGURED","message":"JWT access token configuration is incomplete","requestId":"147206f7-c57a-45cb-8755-c6290e8dc401","details":[],"name":"Error","stack":"Error: JWT access token configuration is incomplete\n    at issueAccessToken (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\security\\access-token.js:30:19)\n    at issueAccessToken (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\routes\\auth.routes.js:56:23)\n    at issueAuthPair (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\routes\\auth.routes.js:109:24)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\strict-validate.middleware.js:13:14)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\middlewares\\rateLimit.js:89:14)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at next (node_modules/express/lib/router/route.js:141:14)
      at next (src/routes/auth.routes.js:123:12)

  console.error
    [2026-02-18T12:12:28.319Z] ERROR http_request_failed {"requestId":"147206f7-c57a-45cb-8755-c6290e8dc401","method":"POST","path":"/api/auth/login","status":500,"elapsedMs":17}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

  console.error
    [2026-02-18T12:12:28.334Z] ERROR api_error {"code":"JWT_MISCONFIGURED","message":"JWT access token configuration is incomplete","requestId":"7ecbb940-1afc-4df7-9af0-3f610ba791b0","details":[],"name":"Error","stack":"Error: JWT access token configuration is incomplete\n    at issueAccessToken (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\security\\access-token.js:30:19)\n    at issueAccessToken (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\routes\\auth.routes.js:56:23)\n    at issueAuthPair (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\routes\\auth.routes.js:86:24)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\strict-validate.middleware.js:13:14)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\middlewares\\rateLimit.js:89:14)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at next (node_modules/express/lib/router/route.js:141:14)
      at next (src/routes/auth.routes.js:102:12)

  console.error
    [2026-02-18T12:12:28.337Z] ERROR http_request_failed {"requestId":"7ecbb940-1afc-4df7-9af0-3f610ba791b0","method":"POST","path":"/api/auth/register","status":500,"elapsedMs":4}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

  console.log
    [2026-02-18T12:12:28.353Z] DEBUG http_request {"requestId":"d6ef29ce-6b52-435d-bb96-c813c9630d3d","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.367Z] DEBUG http_request {"requestId":"129ab8f8-3b7b-48fa-9ac4-694167c70324","method":"POST","path":"/api/auth/refresh","status":200,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.379Z] DEBUG http_request {"requestId":"98277d35-b398-4d85-bfac-0ceaa74ac2ec","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.408Z] DEBUG http_request {"requestId":"5b502326-76eb-497b-a453-9055747ce830","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":6}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:28.418Z] ERROR http_request_failed {"requestId":"9ef64b2f-ab95-43c6-9732-691cd377a44b","method":"POST","path":"/api/auth/refresh","status":500,"elapsedMs":1}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

  console.log
    [2026-02-18T12:12:28.431Z] DEBUG http_request {"requestId":"ce07926e-70f1-4b84-a07e-cfd8f06d451c","method":"POST","path":"/api/auth/forgot","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.445Z] DEBUG http_request {"requestId":"5ffd3c6c-e889-4a65-b2c6-1f645a030330","method":"POST","path":"/api/auth/reset","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.457Z] DEBUG http_request {"requestId":"a85bd401-fd6c-4459-a441-36f760ac3137","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

PASS tests/routes/auth.routes.hardening.test.js (188 MB heap size)
  auth routes hardening branches
    Ã”ÃªÃœ register ignores privileged role and forces customer role (33 ms)
    Ã”ÃªÃœ login fails with 500 if JWT access config missing (31 ms)
    Ã”ÃªÃœ register fails with 500 when JWT access config missing (18 ms)
    Ã”ÃªÃœ refresh and logout accept cookie token path (38 ms)
    Ã”ÃªÃœ refresh returns 500 when refresh JWT config missing (41 ms)
    Ã”ÃªÃœ forgot and reset always return generic responses (26 ms)
    Ã”ÃªÃœ refresh without body or cookie is rejected (12 ms)

  console.log
    [2026-02-18T12:12:28.837Z] DEBUG http_request {"requestId":"392a006f-19c9-46fb-a5c2-65cc56c6fca8","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":6}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.851Z] DEBUG http_request {"requestId":"ac87bd46-0d6c-412b-a616-8cd287686db7","method":"POST","path":"/api/auth/refresh","status":200,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.863Z] DEBUG http_request {"requestId":"919f44be-3ab8-4907-8487-1a4673408111","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.871Z] DEBUG http_request {"requestId":"4f42f573-308f-43ae-ac10-12731b30a807","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.879Z] DEBUG http_request {"requestId":"8b44d972-4b7d-4902-88ae-4913a56cafb4","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.889Z] DEBUG http_request {"requestId":"e5124bf3-d642-49dc-987f-d47b6835a9c6","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.897Z] DEBUG http_request {"requestId":"ecbdfd7a-0b08-4611-8404-6d12edad9b83","method":"POST","path":"/api/auth/refresh","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.904Z] DEBUG http_request {"requestId":"8175dd9e-0ea7-4c8b-a670-e848b8a02430","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.914Z] DEBUG http_request {"requestId":"98aa0ed7-c380-4b03-9bd2-057efc8e25ec","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.935Z] DEBUG http_request {"requestId":"92722434-78fa-49ad-9535-774173b073d4","method":"POST","path":"/api/auth/refresh","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.937Z] DEBUG http_request {"requestId":"39dcf912-1681-47b5-a347-f0fbd086d553","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.950Z] DEBUG http_request {"requestId":"867d4af5-6bec-46f7-ac44-dbe48644a57e","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.958Z] DEBUG http_request {"requestId":"27ebd724-f6b5-495f-8595-87d952c70bca","method":"POST","path":"/api/auth/refresh","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:28.966Z] DEBUG http_request {"requestId":"e94d3293-fc0c-4820-b326-adb2e124359f","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

PASS tests/security/refresh-token-redis.distributed.test.js (201 MB heap size)
  refresh token redis distributed guarantees
    Ã”ÃªÃœ restart simulation keeps refresh session in shared redis state (46 ms)
    Ã”ÃªÃœ multi-instance simulation shares revocation state (27 ms)
    Ã”ÃªÃœ replay old token is rejected immediately after rotation (25 ms)
    Ã”ÃªÃœ concurrent refresh race condition allows only one success (35 ms)
    Ã”ÃªÃœ logout deletes redis key refresh:<tokenId> (25 ms)

  console.log
    [2026-02-18T12:12:29.237Z] DEBUG http_request {"requestId":"d2429a78-1669-4d79-a5e3-e1e92662e420","method":"POST","path":"/api/webhooks/paypal","status":400,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:29.261Z] WARN api_error {"code":"INTERNAL_ERROR","message":"request entity too large","details":[],"name":"PayloadTooLargeError","stack":"PayloadTooLargeError: request entity too large\n    at readStream (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:163:17)\n    at getRawBody (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:116:12)\n    at read (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:79:3)\n    at rawParser (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\types\\raw.js:81:5)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\middlewares\\cors.js:41:10)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\middlewares\\securityHeaders.js:11:10)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at expressInit (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\middleware\\init.js:40:5)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at query (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\middleware\\query.js:45:5)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at router.handle (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:175:3)\n    at app.handle (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\application.js:181:10)\n    at Server.app (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\express.js:39:9)\n    at Server.emit (node:events:508:28)\n    at parserOnIncoming (node:_http_server:1210:12)\n    at HTTPParser.parserOnHeadersComplete (node:_http_common:123:17)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at onfinished (node_modules/body-parser/lib/read.js:102:9)
      at listener (node_modules/on-finished/index.js:170:15)
      at onFinish (node_modules/on-finished/index.js:101:5)
      at callback (node_modules/ee-first/index.js:55:10)
      at IncomingMessage.onevent (node_modules/ee-first/index.js:93:5)

  console.log
    [2026-02-18T12:12:29.274Z] INFO webhook_received {"provider":"paypal","correlationId":"788ffaeb-c88c-498c-9dcb-76ba840bb6b6","payloadSize":300}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.276Z] DEBUG http_request {"requestId":"788ffaeb-c88c-498c-9dcb-76ba840bb6b6","method":"POST","path":"/api/webhooks/paypal","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.285Z] INFO webhook_received {"provider":"paypal","correlationId":"693ba71f-1132-4722-90bf-796a665f44c4","payloadSize":301}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.287Z] DEBUG http_request {"requestId":"693ba71f-1132-4722-90bf-796a665f44c4","method":"POST","path":"/api/webhooks/paypal","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

PASS tests/routes/webhooks.paypal.edge.test.js (227 MB heap size)
  paypal webhook edge coverage
    Ã”ÃªÃœ malformed json triggers paypal parse error handler (26 ms)
    Ã”ÃªÃœ payload too large is rejected by raw parser (25 ms)
    Ã”ÃªÃœ store is lazily created when absent (11 ms)
    Ã”ÃªÃœ paypal route calls verifier with request headers (11 ms)

  console.log
    [2026-02-18T12:12:29.574Z] DEBUG http_request {"requestId":"cbd39641-c82c-416d-92d6-f2a165cee6a9","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":6}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.586Z] DEBUG http_request {"requestId":"f9b0be84-ba18-4430-a88a-e4278c0d54c7","method":"POST","path":"/api/auth/refresh","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.596Z] DEBUG http_request {"requestId":"d3085602-d171-4011-abbe-6ad6bf987a0f","method":"GET","path":"/api/admin/health","status":403,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.607Z] DEBUG http_request {"requestId":"e0ead960-6669-4f34-8939-0753bc001de2","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.618Z] DEBUG http_request {"requestId":"9f999dd8-542d-4b60-b140-1b857c486d82","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.627Z] DEBUG http_request {"requestId":"de253d31-3715-4fce-8f90-22927823bc8d","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.636Z] DEBUG http_request {"requestId":"b417c81b-639b-484c-a473-d6aad967c3a3","method":"POST","path":"/api/auth/login","status":429,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.644Z] DEBUG http_request {"requestId":"06786912-8b32-43aa-a534-c998cd035e0b","method":"POST","path":"/api/auth/login","status":429,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.665Z] DEBUG http_request {"requestId":"a3441ddd-463c-4e6f-a9cd-7edd5f26ba82","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.675Z] DEBUG http_request {"requestId":"2de35765-ebcb-4ca2-a3f6-a249a099fc8f","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

PASS tests/integration/auth.session-hardening.integration.test.js (221 MB heap size)
  Auth integration hardening flow
    Ã”ÃªÃœ login -> refresh rotation -> admin blocked -> bruteforce -> logout -> old refresh reused (126 ms)

  console.log
    [2026-02-18T12:12:29.966Z] DEBUG http_request {"requestId":"55eb968d-f5a2-40c8-a0d7-132c06a1fb37","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":5}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.976Z] DEBUG http_request {"requestId":"d7163857-b13e-4fa4-bf64-1623572ac38e","method":"POST","path":"/api/auth/refresh","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.986Z] DEBUG http_request {"requestId":"32336fc0-9f3e-4b73-8c1b-b97a848aada3","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:29.993Z] DEBUG http_request {"requestId":"f459e5a0-946b-479c-9e3f-d8b1a8d75a8a","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.003Z] DEBUG http_request {"requestId":"ad0ccd71-871d-4e31-90bb-645479a007d8","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.010Z] DEBUG http_request {"requestId":"bdac11f0-59e6-4bdd-a209-ca19b17144be","method":"POST","path":"/api/auth/refresh","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.017Z] DEBUG http_request {"requestId":"29442803-1adb-4c90-8425-75703e225ef0","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.026Z] DEBUG http_request {"requestId":"321410ac-0732-46de-a8cb-14b1646f3b45","method":"POST","path":"/api/auth/refresh","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.034Z] DEBUG http_request {"requestId":"bc6777eb-b192-42e6-8fba-8d73624c4a39","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.042Z] DEBUG http_request {"requestId":"c0ed4249-e650-4079-bc0f-69306ef21c3c","method":"POST","path":"/api/auth/refresh","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.057Z] DEBUG http_request {"requestId":"a507fa2a-c268-43af-bad5-9c0ca4af58e6","method":"POST","path":"/api/auth/refresh","status":429,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.066Z] DEBUG http_request {"requestId":"1215a8d5-bd70-4bd5-9210-24a777e8dcaf","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

PASS tests/routes/auth.refresh.test.js (242 MB heap size)
  Auth refresh flow
    Ã”ÃªÃœ rotates refresh token on refresh (43 ms)
    Ã”ÃªÃœ rejects expired refresh token (16 ms)
    Ã”ÃªÃœ rejects reused refresh token (24 ms)
    Ã”ÃªÃœ rejects unknown refresh token (8 ms)
    Ã”ÃªÃœ limits refresh flood (32 ms)
    Ã”ÃªÃœ logout invalid refresh token returns no content (8 ms)

  console.log
    [2026-02-18T12:12:30.342Z] DEBUG http_request {"requestId":"b4c6c141-8fc7-478e-8fea-92883ffd7384","method":"POST","path":"/api/payments/create-intent","status":201,"elapsedMs":5}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:30.357Z] ERROR api_error {"code":"INTERNAL_ERROR","message":"Stripe down","requestId":"4257fbc2-fb12-419f-86c1-123428d769ce","details":[],"name":"Error","stack":"Error: Stripe down\n    at Object.<anonymous> (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\tests\\routes\\payments.failures.test.js:45:80)\n    at Promise.then.completed (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\utils.js:298:28)\n    at new Promise (<anonymous>)\n    at callAsyncCircusFn (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\utils.js:231:10)\n    at _callCircusTest (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:316:40)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at _runTest (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:252:3)\n    at _runTestsForDescribeBlock (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:126:9)\n    at _runTestsForDescribeBlock (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:121:9)\n    at run (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:71:3)\n    at runAndTransformResultsToJestFormat (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n    at jestAdapter (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n    at runTestInternal (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n    at runTest (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-runner\\build\\runTest.js:444:34)"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at Immediate.next (node_modules/express/lib/router/index.js:280:10)
      at Immediate._onImmediate (node_modules/express/lib/router/index.js:646:15)

  console.error
    [2026-02-18T12:12:30.359Z] ERROR http_request_failed {"requestId":"4257fbc2-fb12-419f-86c1-123428d769ce","method":"POST","path":"/api/payments/create-intent","status":500,"elapsedMs":8}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

  console.warn
    [2026-02-18T12:12:30.369Z] WARN api_error {"code":"INTERNAL_ERROR","message":"Amount mismatch","requestId":"1213f1c8-d5cc-436c-b459-453f244042be","details":[],"name":"Error","stack":"Error: Amount mismatch\n    at Object.<anonymous> (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\tests\\routes\\payments.failures.test.js:53:17)\n    at Promise.then.completed (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\utils.js:298:28)\n    at new Promise (<anonymous>)\n    at callAsyncCircusFn (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\utils.js:231:10)\n    at _callCircusTest (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:316:40)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at _runTest (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:252:3)\n    at _runTestsForDescribeBlock (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:126:9)\n    at _runTestsForDescribeBlock (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:121:9)\n    at run (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:71:3)\n    at runAndTransformResultsToJestFormat (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n    at jestAdapter (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n    at runTestInternal (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n    at runTest (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-runner\\build\\runTest.js:444:34)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at Immediate.next (node_modules/express/lib/router/index.js:280:10)
      at Immediate._onImmediate (node_modules/express/lib/router/index.js:646:15)

  console.log
    [2026-02-18T12:12:30.370Z] DEBUG http_request {"requestId":"1213f1c8-d5cc-436c-b459-453f244042be","method":"POST","path":"/api/payments/create-intent","status":400,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.379Z] DEBUG http_request {"requestId":"3d4ffe97-57a5-464b-b3f3-696c1172ae79","method":"POST","path":"/api/payments/create-intent","status":403,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.387Z] DEBUG http_request {"requestId":"4940f7f9-27af-4c31-a87a-c60332a0cab6","method":"POST","path":"/api/payments/create-intent","status":404,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.397Z] DEBUG http_request {"requestId":"18aab3cb-773a-4f0b-a877-44e0c0fd9368","method":"POST","path":"/api/payments/create-intent","status":400,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

PASS tests/routes/payments.failures.test.js (278 MB heap size)
  payments route failures
    Ã”ÃªÃœ creation session success (32 ms)
    Ã”ÃªÃœ stripe api error surface as 500 (15 ms)
    Ã”ÃªÃœ amount mismatch fails (10 ms)
    Ã”ÃªÃœ user non autorise (8 ms)
    Ã”ÃªÃœ order inexistante/product missing (9 ms)
    Ã”ÃªÃœ devise invalide (9 ms)

  console.log
    [2026-02-18T12:12:30.672Z] DEBUG http_request {"requestId":"8e741190-32cb-4dd6-a349-824ffcba94cf","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.681Z] DEBUG http_request {"requestId":"b03eae7e-701e-4359-bc38-1014675e54b8","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.687Z] DEBUG http_request {"requestId":"c58ed6cd-1060-4a0a-9f96-0109a3964dd8","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.697Z] DEBUG http_request {"requestId":"336170d3-f2c2-4e9b-81f9-2b0ab3978092","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.704Z] DEBUG http_request {"requestId":"c2d6a45b-b8b8-4d3b-ba3f-266b1320334f","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.713Z] DEBUG http_request {"requestId":"ccf48c12-639f-49a2-9052-9780b8428d35","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.721Z] DEBUG http_request {"requestId":"b098c51c-3fa6-47e6-9c6c-83b6c6aac2e2","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.736Z] DEBUG http_request {"requestId":"1332a449-1851-4e00-89db-7485e16d3bd1","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.744Z] DEBUG http_request {"requestId":"d2f07c6e-a279-4b2d-a987-c86aac2a1e77","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.752Z] DEBUG http_request {"requestId":"e8d546cd-d240-4930-88ec-10d88433bf95","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:30.760Z] DEBUG http_request {"requestId":"ebdf4939-6b43-48a5-a33c-0738efa140a6","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

PASS tests/routes/auth.logout.test.js (280 MB heap size)
  Auth logout consistency
    Ã”ÃªÃœ logout is idempotent across double call (37 ms)
    Ã”ÃªÃœ logout with valid refresh token returns 204 and clears refresh cookie (17 ms)
    Ã”ÃªÃœ logout without token returns 204 (8 ms)
    Ã”ÃªÃœ logout with already revoked token returns 204 (31 ms)
    Ã”ÃªÃœ logout with malformed refresh token returns 204 without leaking state (8 ms)
    Ã”ÃªÃœ logout with malformed token injection returns 204 (8 ms)

  console.error
    [2026-02-18T12:12:31.033Z] ERROR rate_limit_backend_down {"event":"rate_limit_backend_down","key":"rate:auth:login:127.0.0.1","message":"Redis client unavailable"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at Object.error [as increment] (src/lib/rate-limit-redis-store.js:26:14)
      at increment (src/middlewares/rateLimit.js:81:34)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/requestLogger.js:29:10)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/requestContext.js:10:10)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/cookieParser.js:24:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    [2026-02-18T12:12:31.036Z] ERROR rate_limit_backend_down {"level":"error","event":"rate_limit_backend_down"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/middlewares/rateLimit.js:91:14)

  console.error
    [2026-02-18T12:12:31.038Z] ERROR http_request_failed {"requestId":"001941c8-7f2f-43c1-80ae-6afddafa47b7","method":"POST","path":"/api/auth/login","status":503,"elapsedMs":5}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

  console.error
    [2026-02-18T12:12:31.045Z] ERROR rate_limit_backend_down {"event":"rate_limit_backend_down","key":"rate:auth:register:127.0.0.1","message":"Redis client unavailable"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at Object.error [as increment] (src/lib/rate-limit-redis-store.js:26:14)
      at increment (src/middlewares/rateLimit.js:81:34)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/requestLogger.js:29:10)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/requestContext.js:10:10)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/cookieParser.js:24:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    [2026-02-18T12:12:31.047Z] ERROR rate_limit_backend_down {"level":"error","event":"rate_limit_backend_down"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/middlewares/rateLimit.js:91:14)

  console.error
    [2026-02-18T12:12:31.048Z] ERROR http_request_failed {"requestId":"fccb8cec-cab3-496a-b7cc-2b787a56a52b","method":"POST","path":"/api/auth/register","status":503,"elapsedMs":3}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

  console.error
    [2026-02-18T12:12:31.054Z] ERROR rate_limit_backend_down {"event":"rate_limit_backend_down","key":"rate:auth:refresh:127.0.0.1","message":"Redis client unavailable"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at Object.error [as increment] (src/lib/rate-limit-redis-store.js:26:14)
      at increment (src/middlewares/rateLimit.js:81:34)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/requestLogger.js:29:10)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/requestContext.js:10:10)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/cookieParser.js:24:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    [2026-02-18T12:12:31.056Z] ERROR rate_limit_backend_down {"level":"error","event":"rate_limit_backend_down"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/middlewares/rateLimit.js:91:14)

  console.error
    [2026-02-18T12:12:31.057Z] ERROR http_request_failed {"requestId":"d7d0a229-74cf-481d-bfb8-0550b8e47732","method":"POST","path":"/api/auth/refresh","status":503,"elapsedMs":3}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

  console.error
    [2026-02-18T12:12:31.066Z] ERROR rate_limit_backend_down {"event":"rate_limit_backend_down","key":"rate:payments:create-intent:127.0.0.1","message":"Redis client unavailable"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at Object.error [as increment] (src/lib/rate-limit-redis-store.js:26:14)
      at increment (src/middlewares/rateLimit.js:81:34)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/requestLogger.js:29:10)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/requestContext.js:10:10)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/cookieParser.js:24:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    [2026-02-18T12:12:31.067Z] ERROR rate_limit_backend_down {"level":"error","event":"rate_limit_backend_down"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/middlewares/rateLimit.js:91:14)

  console.error
    [2026-02-18T12:12:31.068Z] ERROR http_request_failed {"requestId":"b66982e2-a37a-4ed5-868d-d8342e4c6124","method":"POST","path":"/api/payments/create-intent","status":503,"elapsedMs":3}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

  console.error
    [2026-02-18T12:12:31.076Z] ERROR rate_limit_backend_down {"event":"rate_limit_backend_down","key":"rate:webhooks:stripe:127.0.0.1","message":"Redis client unavailable"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at Object.error [as increment] (src/lib/rate-limit-redis-store.js:26:14)
      at increment (src/middlewares/rateLimit.js:81:34)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/requestLogger.js:29:10)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/requestContext.js:10:10)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/cookieParser.js:24:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at jsonParser (node_modules/body-parser/lib/types/json.js:104:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    [2026-02-18T12:12:31.078Z] ERROR rate_limit_backend_down {"level":"error","event":"rate_limit_backend_down"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/middlewares/rateLimit.js:91:14)

  console.error
    [2026-02-18T12:12:31.079Z] ERROR http_request_failed {"requestId":"3f7de4fe-da18-45bc-afd7-f978e1b68562","method":"POST","path":"/api/webhooks/stripe","status":503,"elapsedMs":3}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

  console.error
    [2026-02-18T12:12:31.086Z] ERROR rate_limit_backend_down {"event":"rate_limit_backend_down","key":"rate:webhooks:paypal:127.0.0.1","message":"Redis client unavailable"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at Object.error [as increment] (src/lib/rate-limit-redis-store.js:26:14)
      at increment (src/middlewares/rateLimit.js:81:34)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/requestLogger.js:29:10)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/requestContext.js:10:10)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/cookieParser.js:24:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at jsonParser (node_modules/body-parser/lib/types/json.js:104:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    [2026-02-18T12:12:31.088Z] ERROR rate_limit_backend_down {"level":"error","event":"rate_limit_backend_down"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/middlewares/rateLimit.js:91:14)

  console.error
    [2026-02-18T12:12:31.089Z] ERROR http_request_failed {"requestId":"1fc9cc00-f9bc-4421-bb66-ec177a53fc21","method":"POST","path":"/api/webhooks/paypal","status":503,"elapsedMs":3}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

  console.log
    [2026-02-18T12:12:31.113Z] DEBUG http_request {"requestId":"86a75fee-0bdd-4b45-af37-c46ddee7e7ad","method":"GET","path":"/healthz","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:31.120Z] ERROR http_request_failed {"requestId":"f44689ae-0e79-4969-9d0a-1662b2d0d963","method":"GET","path":"/healthz","status":503,"elapsedMs":1}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

PASS tests/security/rate-limit.fail-closed.test.js (286 MB heap size)
  rate-limit fail-closed hardening
    Ã”ÃªÃœ returns 503 on sensitive auth routes when redis is down (53 ms)
    Ã”ÃªÃœ returns 503 on payment route when redis is down (10 ms)
    Ã”ÃªÃœ returns 503 on webhook routes when redis is down (20 ms)
    Ã”ÃªÃœ logs rate_limit_backend_down as structured error (8 ms)
    Ã”ÃªÃœ /healthz exposes redis status (25 ms)

  console.log
    [2026-02-18T12:12:31.379Z] INFO webhook_received {"provider":"stripe","correlationId":"dae839d9-b63d-4a15-bdc0-030b5c2603c8","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.382Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_full_1","eventType":"payment_intent.succeeded","correlationId":"dae839d9-b63d-4a15-bdc0-030b5c2603c8"}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.384Z] DEBUG http_request {"requestId":"dae839d9-b63d-4a15-bdc0-030b5c2603c8","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":6}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.401Z] INFO webhook_received {"provider":"stripe","correlationId":"4724f299-5e9e-4170-a371-24be1a629df9","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.402Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_full_1","eventType":"payment_intent.succeeded","correlationId":"4724f299-5e9e-4170-a371-24be1a629df9"}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:31.402Z] WARN webhook_replay_detected {"provider":"stripe","eventId":"evt_full_1","orderId":"00000000-0000-0000-0000-000000000111","reason":"replay","correlationId":"4724f299-5e9e-4170-a371-24be1a629df9"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:65:12)
      at src/routes/webhooks.routes.js:133:28

  console.log
    [2026-02-18T12:12:31.404Z] DEBUG http_request {"requestId":"4724f299-5e9e-4170-a371-24be1a629df9","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.413Z] INFO webhook_received {"provider":"stripe","correlationId":"ac8f74fd-530e-414f-ad88-c8db2418295b","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.413Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_full_2","eventType":"payment_intent.succeeded","correlationId":"ac8f74fd-530e-414f-ad88-c8db2418295b"}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.415Z] DEBUG http_request {"requestId":"ac8f74fd-530e-414f-ad88-c8db2418295b","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.416Z] INFO webhook_received {"provider":"stripe","correlationId":"1d396f54-7e21-4bed-bd1b-ea5febce7225","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.417Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_full_2","eventType":"payment_intent.succeeded","correlationId":"1d396f54-7e21-4bed-bd1b-ea5febce7225"}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:31.417Z] WARN webhook_replay_detected {"provider":"stripe","eventId":"evt_full_2","orderId":"00000000-0000-0000-0000-000000000111","reason":"replay","correlationId":"1d396f54-7e21-4bed-bd1b-ea5febce7225"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:65:12)
      at src/routes/webhooks.routes.js:133:28

  console.log
    [2026-02-18T12:12:31.419Z] DEBUG http_request {"requestId":"1d396f54-7e21-4bed-bd1b-ea5febce7225","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.427Z] INFO webhook_received {"provider":"stripe","correlationId":"7d7fb37e-3872-4d46-b827-478187a74a41","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.428Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_full_3","eventType":"payment_intent.succeeded","correlationId":"7d7fb37e-3872-4d46-b827-478187a74a41"}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:31.429Z] ERROR webhook_order_state_incompatible {"provider":"stripe","eventId":"evt_full_3","orderId":"00000000-0000-0000-0000-000000000111","status":"cancelled","correlationId":"7d7fb37e-3872-4d46-b827-478187a74a41"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/routes/webhooks.routes.js:158:14)

  console.log
    [2026-02-18T12:12:31.430Z] DEBUG http_request {"requestId":"7d7fb37e-3872-4d46-b827-478187a74a41","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.436Z] INFO webhook_received {"provider":"stripe","correlationId":"98877557-9e18-46e1-8185-a0fe83ae0e78","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:31.437Z] WARN stripe_webhook_signature_validation_failed {"reason":"Stripe signature timestamp outside tolerance","correlationId":"98877557-9e18-46e1-8185-a0fe83ae0e78"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:110:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:31.439Z] DEBUG http_request {"requestId":"98877557-9e18-46e1-8185-a0fe83ae0e78","method":"POST","path":"/api/webhooks/stripe","status":400,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

PASS tests/routes/webhooks.integration.advanced.test.js (319 MB heap size)
  advanced webhook integration scenarios
    Ã”ÃªÃœ order lifecycle + retries + concurrent duplicate + cancel + expired timestamp (72 ms)

  console.log
    [2026-02-18T12:12:31.708Z] INFO webhook_received {"provider":"stripe","correlationId":"8035fe06-85d6-4967-9207-9ecb93852772","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:31.709Z] WARN stripe_webhook_signature_validation_failed {"reason":"Malformed webhook payload","correlationId":"8035fe06-85d6-4967-9207-9ecb93852772"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:110:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:31.712Z] DEBUG http_request {"requestId":"8035fe06-85d6-4967-9207-9ecb93852772","method":"POST","path":"/api/webhooks/stripe","status":400,"elapsedMs":5}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:31.742Z] WARN api_error {"code":"INTERNAL_ERROR","message":"request entity too large","details":[],"name":"PayloadTooLargeError","stack":"PayloadTooLargeError: request entity too large\n    at readStream (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:163:17)\n    at getRawBody (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:116:12)\n    at read (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:79:3)\n    at rawParser (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\types\\raw.js:81:5)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\middlewares\\cors.js:41:10)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\middlewares\\securityHeaders.js:11:10)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at expressInit (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\middleware\\init.js:40:5)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at query (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\middleware\\query.js:45:5)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at router.handle (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:175:3)\n    at app.handle (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\application.js:181:10)\n    at Server.app (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\express.js:39:9)\n    at Server.emit (node:events:508:28)\n    at parserOnIncoming (node:_http_server:1210:12)\n    at HTTPParser.parserOnHeadersComplete (node:_http_common:123:17)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at onfinished (node_modules/body-parser/lib/read.js:102:9)
      at listener (node_modules/on-finished/index.js:170:15)
      at onFinish (node_modules/on-finished/index.js:101:5)
      at callback (node_modules/ee-first/index.js:55:10)
      at IncomingMessage.onevent (node_modules/ee-first/index.js:93:5)

  console.log
    [2026-02-18T12:12:31.760Z] INFO webhook_received {"provider":"stripe","correlationId":"bac8c722-c713-49a2-a756-408714d31e16","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:31.762Z] WARN webhook_payload_invalid {"provider":"stripe","message":"[\n  {\n    \"code\": \"invalid_type\",\n    \"expected\": \"string\",\n    \"received\": \"undefined\",\n    \"path\": [\n      \"data\",\n      \"object\",\n      \"metadata\",\n      \"orderId\"\n    ],\n    \"message\": \"Required\"\n  }\n]","correlationId":"bac8c722-c713-49a2-a756-408714d31e16"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:206:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:31.765Z] DEBUG http_request {"requestId":"bac8c722-c713-49a2-a756-408714d31e16","method":"POST","path":"/api/webhooks/stripe","status":400,"elapsedMs":6}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.810Z] INFO webhook_received {"provider":"stripe","correlationId":"64241738-eeb7-4897-8964-cae407339f36","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.812Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_amount_mismatch","eventType":"payment_intent.succeeded","correlationId":"64241738-eeb7-4897-8964-cae407339f36"}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:31.814Z] ERROR webhook_amount_mismatch {"provider":"stripe","eventId":"evt_amount_mismatch","orderId":"00000000-0000-0000-0000-000000000111","expectedMinor":1200,"receivedMinor":999,"correlationId":"64241738-eeb7-4897-8964-cae407339f36"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/routes/webhooks.routes.js:170:14)

  console.log
    [2026-02-18T12:12:31.815Z] DEBUG http_request {"requestId":"64241738-eeb7-4897-8964-cae407339f36","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":5}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.824Z] INFO webhook_received {"provider":"stripe","correlationId":"77250b36-8496-4495-965a-377742771b2e","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.824Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_currency_mismatch","eventType":"payment_intent.succeeded","correlationId":"77250b36-8496-4495-965a-377742771b2e"}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:31.825Z] ERROR webhook_currency_mismatch {"provider":"stripe","eventId":"evt_currency_mismatch","orderId":"00000000-0000-0000-0000-000000000111","expectedCurrency":"EUR","receivedCurrency":"USD","correlationId":"77250b36-8496-4495-965a-377742771b2e"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/routes/webhooks.routes.js:182:14)

  console.log
    [2026-02-18T12:12:31.826Z] DEBUG http_request {"requestId":"77250b36-8496-4495-965a-377742771b2e","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.833Z] INFO webhook_received {"provider":"stripe","correlationId":"3db02ce3-b0d8-4b39-801d-784115da6cb4","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.834Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_unknown","eventType":"charge.pending","correlationId":"3db02ce3-b0d8-4b39-801d-784115da6cb4"}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:31.835Z] DEBUG http_request {"requestId":"3db02ce3-b0d8-4b39-801d-784115da6cb4","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

PASS tests/routes/webhooks.payload.test.js (246 MB heap size)
  webhooks payload integrity
    Ã”ÃªÃœ rejects malformed json (19 ms)
    Ã”ÃªÃœ rejects too large payload (35 ms)
    Ã”ÃªÃœ rejects missing mandatory field (50 ms)
    Ã”ÃªÃœ ignores amount mismatch (17 ms)
    Ã”ÃªÃœ ignores currency mismatch (10 ms)
    Ã”ÃªÃœ unknown event type is ignored (9 ms)

  console.log
    [2026-02-18T12:12:32.111Z] INFO webhook_received {"provider":"stripe","correlationId":"b2a9dbb4-c59b-4247-9660-a61c7b8100a8","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.113Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_replay_first","eventType":"payment_intent.succeeded","correlationId":"b2a9dbb4-c59b-4247-9660-a61c7b8100a8"}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.116Z] DEBUG http_request {"requestId":"b2a9dbb4-c59b-4247-9660-a61c7b8100a8","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":6}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.125Z] INFO webhook_received {"provider":"stripe","correlationId":"c014d601-9306-46d4-b6ea-e9aac5fb63cc","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.126Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_replay_dupe","eventType":"payment_intent.succeeded","correlationId":"c014d601-9306-46d4-b6ea-e9aac5fb63cc"}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.127Z] DEBUG http_request {"requestId":"c014d601-9306-46d4-b6ea-e9aac5fb63cc","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.133Z] INFO webhook_received {"provider":"stripe","correlationId":"e2b2cbf0-c6d6-4468-99b3-0b3732107eb2","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.134Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_replay_dupe","eventType":"payment_intent.succeeded","correlationId":"e2b2cbf0-c6d6-4468-99b3-0b3732107eb2"}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:32.135Z] WARN webhook_replay_detected {"provider":"stripe","eventId":"evt_replay_dupe","orderId":"00000000-0000-0000-0000-000000000111","reason":"replay","correlationId":"e2b2cbf0-c6d6-4468-99b3-0b3732107eb2"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:65:12)
      at src/routes/webhooks.routes.js:133:28

  console.log
    [2026-02-18T12:12:32.136Z] DEBUG http_request {"requestId":"e2b2cbf0-c6d6-4468-99b3-0b3732107eb2","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.144Z] INFO webhook_received {"provider":"stripe","correlationId":"9963fa6a-a02a-451f-b154-54129f8c7874","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:32.145Z] WARN webhook_payload_invalid {"provider":"stripe","message":"[\n  {\n    \"code\": \"too_small\",\n    \"minimum\": 1,\n    \"type\": \"string\",\n    \"inclusive\": true,\n    \"exact\": false,\n    \"message\": \"String must contain at least 1 character(s)\",\n    \"path\": [\n      \"id\"\n    ]\n  }\n]","correlationId":"9963fa6a-a02a-451f-b154-54129f8c7874"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:206:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:32.147Z] DEBUG http_request {"requestId":"9963fa6a-a02a-451f-b154-54129f8c7874","method":"POST","path":"/api/webhooks/stripe","status":400,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.158Z] INFO webhook_received {"provider":"stripe","correlationId":"050fab8f-d752-4972-ad8e-be06fec2d3f4","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.159Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_replay_concurrent","eventType":"payment_intent.succeeded","correlationId":"050fab8f-d752-4972-ad8e-be06fec2d3f4"}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.160Z] DEBUG http_request {"requestId":"050fab8f-d752-4972-ad8e-be06fec2d3f4","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.161Z] INFO webhook_received {"provider":"stripe","correlationId":"5d6843b1-ef86-4a28-b268-d4b4da170377","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.162Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_replay_concurrent","eventType":"payment_intent.succeeded","correlationId":"5d6843b1-ef86-4a28-b268-d4b4da170377"}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:32.162Z] WARN webhook_replay_detected {"provider":"stripe","eventId":"evt_replay_concurrent","orderId":"00000000-0000-0000-0000-000000000111","reason":"replay","correlationId":"5d6843b1-ef86-4a28-b268-d4b4da170377"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:65:12)
      at src/routes/webhooks.routes.js:133:28

  console.log
    [2026-02-18T12:12:32.164Z] DEBUG http_request {"requestId":"5d6843b1-ef86-4a28-b268-d4b4da170377","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

PASS tests/routes/webhooks.replay.test.js (276 MB heap size)
  webhooks replay protection
    Ã”ÃªÃœ first event is processed (28 ms)
    Ã”ÃªÃœ second event with same id is ignored (19 ms)
    Ã”ÃªÃœ null event id is rejected (11 ms)
    Ã”ÃªÃœ double concurrent webhook only processes once (18 ms)

  console.log
    [2026-02-18T12:12:32.444Z] INFO webhook_received {"provider":"stripe","correlationId":"c4af10a3-acc0-4fd5-ae60-44b7608191c5","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.446Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_sig_ok","eventType":"payment_intent.succeeded","correlationId":"c4af10a3-acc0-4fd5-ae60-44b7608191c5"}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.449Z] DEBUG http_request {"requestId":"c4af10a3-acc0-4fd5-ae60-44b7608191c5","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":6}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.458Z] INFO webhook_received {"provider":"stripe","correlationId":"17713dad-74d5-4227-96c9-309293e18192","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:32.458Z] WARN stripe_webhook_signature_validation_failed {"reason":"No signatures found matching the expected scheme","correlationId":"17713dad-74d5-4227-96c9-309293e18192"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:110:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:32.460Z] DEBUG http_request {"requestId":"17713dad-74d5-4227-96c9-309293e18192","method":"POST","path":"/api/webhooks/stripe","status":400,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.468Z] INFO webhook_received {"provider":"stripe","correlationId":"3fdba434-1238-492f-85f5-d11a7611865a","hasSignature":false}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:32.469Z] WARN stripe_webhook_invalid_input {"hasSecret":true,"hasSignature":false,"isBuffer":true,"correlationId":"3fdba434-1238-492f-85f5-d11a7611865a"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:97:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:32.471Z] DEBUG http_request {"requestId":"3fdba434-1238-492f-85f5-d11a7611865a","method":"POST","path":"/api/webhooks/stripe","status":400,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.478Z] INFO webhook_received {"provider":"stripe","correlationId":"30f60155-b3af-45a0-8460-58d240e172af","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:32.479Z] WARN stripe_webhook_signature_validation_failed {"reason":"Stripe signature timestamp outside tolerance","correlationId":"30f60155-b3af-45a0-8460-58d240e172af"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:110:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:32.481Z] DEBUG http_request {"requestId":"30f60155-b3af-45a0-8460-58d240e172af","method":"POST","path":"/api/webhooks/stripe","status":400,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.488Z] INFO webhook_received {"provider":"stripe","correlationId":"c2550437-14b1-4ed6-9288-bd08ba9da763","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:32.489Z] WARN stripe_webhook_invalid_input {"hasSecret":false,"hasSignature":true,"isBuffer":true,"correlationId":"c2550437-14b1-4ed6-9288-bd08ba9da763"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/routes/webhooks.routes.js:97:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/rateLimit.js:89:14)

  console.log
    [2026-02-18T12:12:32.490Z] DEBUG http_request {"requestId":"c2550437-14b1-4ed6-9288-bd08ba9da763","method":"POST","path":"/api/webhooks/stripe","status":400,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

PASS tests/routes/webhooks.signature.test.js (297 MB heap size)
  webhooks signature security
    Ã”ÃªÃœ accepts valid stripe signature (20 ms)
    Ã”ÃªÃœ rejects invalid stripe signature (10 ms)
    Ã”ÃªÃœ rejects missing stripe header (10 ms)
    Ã”ÃªÃœ rejects expired stripe timestamp (10 ms)
    Ã”ÃªÃœ rejects when secret is absent (10 ms)

  console.log
    [2026-02-18T12:12:32.771Z] DEBUG http_request {"requestId":"c12b9e25-b80f-40f0-b069-6179b66a5fb2","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":5}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.782Z] INFO http_request {"requestId":"919298d0-de83-4d28-9446-2fb3de21793d","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.790Z] DEBUG http_request {"requestId":"f5758c2b-6ee9-4879-b479-e00614658847","method":"POST","path":"/api/auth/login","status":200,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:32.799Z] DEBUG http_request {"requestId":"37a847db-c1e1-4da2-b9bd-b3b66774c236","method":"POST","path":"/api/auth/logout","status":204,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

PASS tests/security/cookie.flags.test.js (307 MB heap size)
  Cookie security flags
    Ã”ÃªÃœ sets HttpOnly refresh cookie (23 ms)
    Ã”ÃªÃœ sets Secure in production (9 ms)
    Ã”ÃªÃœ sets SameSite correctly (9 ms)
    Ã”ÃªÃœ missing refresh cookie/token returns no content (8 ms)

  console.log
    [2026-02-18T12:12:33.081Z] INFO webhook_received {"provider":"stripe","correlationId":"10ce564b-6e9c-43e9-ac02-c281d52661a9","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:33.083Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_ordering_1","eventType":"payment_intent.succeeded","correlationId":"10ce564b-6e9c-43e9-ac02-c281d52661a9"}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:33.084Z] ERROR webhook_order_not_found {"provider":"stripe","eventId":"evt_ordering_1","orderId":"00000000-0000-0000-0000-000000000111","correlationId":"10ce564b-6e9c-43e9-ac02-c281d52661a9"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/routes/webhooks.routes.js:148:14)

  console.log
    [2026-02-18T12:12:33.086Z] DEBUG http_request {"requestId":"10ce564b-6e9c-43e9-ac02-c281d52661a9","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":6}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:33.097Z] INFO webhook_received {"provider":"stripe","correlationId":"e6fe792f-f3a2-4dd3-97ad-5ff0d14bc014","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:33.098Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_ordering_1","eventType":"payment_intent.succeeded","correlationId":"e6fe792f-f3a2-4dd3-97ad-5ff0d14bc014"}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:33.098Z] ERROR webhook_order_state_incompatible {"provider":"stripe","eventId":"evt_ordering_1","orderId":"00000000-0000-0000-0000-000000000111","status":"cancelled","correlationId":"e6fe792f-f3a2-4dd3-97ad-5ff0d14bc014"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/routes/webhooks.routes.js:158:14)

  console.log
    [2026-02-18T12:12:33.100Z] DEBUG http_request {"requestId":"e6fe792f-f3a2-4dd3-97ad-5ff0d14bc014","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:33.109Z] INFO webhook_received {"provider":"stripe","correlationId":"6b46ddb6-13cf-46e8-b486-1b3b36418620","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:33.110Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_ordering_1","eventType":"payment_intent.succeeded","correlationId":"6b46ddb6-13cf-46e8-b486-1b3b36418620"}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:33.111Z] ERROR webhook_order_state_incompatible {"provider":"stripe","eventId":"evt_ordering_1","orderId":"00000000-0000-0000-0000-000000000111","status":"processing","correlationId":"6b46ddb6-13cf-46e8-b486-1b3b36418620"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/routes/webhooks.routes.js:158:14)

  console.log
    [2026-02-18T12:12:33.112Z] DEBUG http_request {"requestId":"6b46ddb6-13cf-46e8-b486-1b3b36418620","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:33.136Z] INFO webhook_received {"provider":"stripe","correlationId":"7c3e157c-f665-4b9e-b2c1-e0eabd29a711","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:33.137Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_ordering_1","eventType":"payment_intent.succeeded","correlationId":"7c3e157c-f665-4b9e-b2c1-e0eabd29a711"}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:33.137Z] ERROR webhook_order_state_incompatible {"provider":"stripe","eventId":"evt_ordering_1","orderId":"00000000-0000-0000-0000-000000000111","status":"paid","correlationId":"7c3e157c-f665-4b9e-b2c1-e0eabd29a711"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/routes/webhooks.routes.js:158:14)

  console.log
    [2026-02-18T12:12:33.139Z] DEBUG http_request {"requestId":"7c3e157c-f665-4b9e-b2c1-e0eabd29a711","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

PASS tests/routes/webhooks.ordering.test.js (291 MB heap size)
  webhooks event ordering guards
    Ã”ÃªÃœ event before order creation is ignored (22 ms)
    Ã”ÃªÃœ event after cancellation is ignored (12 ms)
    Ã”ÃªÃœ event during update/inconsistent state is ignored (12 ms)
    Ã”ÃªÃœ already paid status is ignored (26 ms)

  console.warn
    [2026-02-18T12:12:33.397Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"email","message":"email must be a valid email address"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    [2026-02-18T12:12:33.410Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"password","message":"password must contain at least 8 characters"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    [2026-02-18T12:12:33.420Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"payload","message":"unknown field in register payload"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    [2026-02-18T12:12:33.429Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"email","message":"email is required"},{"field":"password","message":"password is required"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    [2026-02-18T12:12:33.439Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"payload","message":"Content-Type must be application/json"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:20:23\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at jsonParser (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\types\\json.js:122:7)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at expressInit (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\middleware\\init.js:40:5)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at query (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\middleware\\query.js:45:5)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:286:9\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at router.handle (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:175:3)\n    at app.handle (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\application.js:181:10)\n    at Server.app (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\express.js:39:9)\n    at Server.emit (node:events:508:28)\n    at parserOnIncoming (node:_http_server:1210:12)\n    at HTTPParser.parserOnHeadersComplete (node:_http_common:123:17)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:20:18)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at jsonParser (node_modules/body-parser/lib/types/json.js:122:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at expressInit (node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at query (node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at router.handle (node_modules/express/lib/router/index.js:175:3)
      at app.handle (node_modules/express/lib/application.js:181:10)
      at Server.app (node_modules/express/lib/express.js:39:9)

PASS tests/validation/auth.validation.test.js (316 MB heap size)
  Auth validation
    Ã”ÃªÃœ rejects invalid email (40 ms)
    Ã”ÃªÃœ rejects short password (10 ms)
    Ã”ÃªÃœ rejects unknown injected field (9 ms)
    Ã”ÃªÃœ rejects empty body (10 ms)
    Ã”ÃªÃœ rejects incorrect content-type body (11 ms)

  console.log
    [2026-02-18T12:12:33.710Z] DEBUG http_request {"requestId":"0738d861-0258-4740-aa94-f763e70c430f","method":"GET","path":"/api/admin/health","status":200,"elapsedMs":4}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:33.720Z] DEBUG http_request {"requestId":"0e4391c0-67ac-4d1c-8b3b-c1fe3f4d9488","method":"GET","path":"/api/admin/health","status":403,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:33.728Z] DEBUG http_request {"requestId":"daa05500-87ed-4338-a8f8-f28537b94986","method":"GET","path":"/api/admin/health","status":401,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:33.735Z] DEBUG http_request {"requestId":"5470d1c0-d31c-4d33-9d7c-2ef393c431c7","method":"GET","path":"/api/admin/health","status":403,"elapsedMs":1}

      at log (src/utils/logger.js:44:11)

PASS tests/security/rbac.enforcement.test.js (330 MB heap size)
  RBAC enforcement
    Ã”ÃªÃœ admin is allowed (17 ms)
    Ã”ÃªÃœ customer is blocked (8 ms)
    Ã”ÃªÃœ admin endpoints are guarded (7 ms)
    Ã”ÃªÃœ missing permission is blocked (7 ms)

  console.warn
    [2026-02-18T12:12:33.989Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"price","message":"price must be greater than 0"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    [2026-02-18T12:12:34.001Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"name","message":"name must contain at least 3 characters"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    [2026-02-18T12:12:34.012Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"price","message":"price must be a number"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    [2026-02-18T12:12:34.022Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"name","message":"name must contain at most 150 characters"},{"field":"description","message":"description must contain at most 2000 characters"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

PASS tests/validation/products.validation.test.js (338 MB heap size)
  Products validation
    Ã”ÃªÃœ rejects negative price with VALIDATION_ERROR (39 ms)
    Ã”ÃªÃœ executes validation before auth (invalid body returns 400 even without token) (9 ms)
    Ã”ÃªÃœ rejects SQL-like payload as invalid type/constraints (12 ms)
    Ã”ÃªÃœ rejects massive payload over limits (10 ms)

  console.warn
    [2026-02-18T12:12:34.262Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"quantity","message":"quantity must be at least 1"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    [2026-02-18T12:12:34.275Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"productId","message":"productId must be a valid UUID"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    [2026-02-18T12:12:34.285Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"payload","message":"unknown field in cart payload"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

PASS tests/validation/cart.validation.test.js (343 MB heap size)
  Cart validation
    Ã”ÃªÃœ rejects quantity equal to 0 (38 ms)
    Ã”ÃªÃœ rejects script tag payload with invalid productId format (10 ms)
    Ã”ÃªÃœ rejects unknown field injection (10 ms)

  console.log
    [2026-02-18T12:12:34.559Z] INFO webhook_received {"provider":"stripe","correlationId":"e8e64d61-8122-4b6a-a993-0c241fc92783","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:34.561Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_ok","eventType":"payment_intent.succeeded","correlationId":"e8e64d61-8122-4b6a-a993-0c241fc92783"}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:34.563Z] DEBUG http_request {"requestId":"e8e64d61-8122-4b6a-a993-0c241fc92783","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":5}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:34.574Z] INFO webhook_received {"provider":"stripe","correlationId":"9ae265f6-9d97-438c-9fd3-3024350d2133","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:34.574Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_ok","eventType":"payment_intent.processing","correlationId":"9ae265f6-9d97-438c-9fd3-3024350d2133"}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:34.576Z] DEBUG http_request {"requestId":"9ae265f6-9d97-438c-9fd3-3024350d2133","method":"POST","path":"/api/webhooks/stripe","status":200,"elapsedMs":3}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:34.584Z] INFO webhook_received {"provider":"paypal","correlationId":"a5ced25d-6dc1-4093-882d-a7fa91ed7b0d","payloadSize":292}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:34.585Z] DEBUG http_request {"requestId":"a5ced25d-6dc1-4093-882d-a7fa91ed7b0d","method":"POST","path":"/api/webhooks/paypal","status":200,"elapsedMs":2}

      at log (src/utils/logger.js:44:11)

PASS tests/routes/webhooks.integrity.test.js (364 MB heap size)
  webhooks integrity
    Ã”ÃªÃœ event success (31 ms)
    Ã”ÃªÃœ event type inconnu ignored (10 ms)
    Ã”ÃªÃœ paypal replay response passthrough (10 ms)

  console.warn
    [2026-02-18T12:12:34.822Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"payload","message":"Content-Type must be application/json"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:20:23\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:20:18)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    [2026-02-18T12:12:34.833Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"payload","message":"request body must be a JSON object"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:24:23\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:24:18)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.error
    [2026-02-18T12:12:34.851Z] ERROR api_error {"code":"INTERNAL_ERROR","message":"boom","details":[],"name":"Error","stack":"Error: boom\n    at Object.parse (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\tests\\validation\\validation-runtime-extra.test.js:78:52)\n    at parse (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:28:30)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:34:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

PASS tests/validation/validation-runtime-extra.test.js (368 MB heap size)
  validation coverage hardening
    Ã”ÃªÃœ validate throws on invalid property selector (8 ms)
    Ã”ÃªÃœ validate rejects non-json content-type with payload (32 ms)
    Ã”ÃªÃœ validate rejects non-object JSON body (9 ms)
    Ã”ÃªÃœ cart legacy addItem + sync strict schemas are enforced (3 ms)
    Ã”ÃªÃœ orders create schema rejects client-provided userId (1 ms)
    Ã”ÃªÃœ analytics track rejects client-provided userId (1 ms)
    Ã”ÃªÃœ query/params schemas accept valid payload (1 ms)
    Ã”ÃªÃœ validate forwards unexpected parser errors (10 ms)
    Ã”ÃªÃœ cart add schema supports uuid and legacy id branches (1 ms)

  console.log
    [2026-02-18T12:12:35.119Z] INFO webhook_received {"provider":"stripe","correlationId":"342902e0-5914-42ad-b331-e49a28353030","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:35.122Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_bad_status","eventType":"payment_intent.succeeded","correlationId":"342902e0-5914-42ad-b331-e49a28353030"}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:35.124Z] DEBUG http_request {"requestId":"342902e0-5914-42ad-b331-e49a28353030","method":"POST","path":"/api/webhooks/stripe","status":400,"elapsedMs":6}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:35.133Z] INFO webhook_received {"provider":"stripe","correlationId":"5d08d607-cd5a-40f7-86ce-7b100d6fce72","hasSignature":true}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:35.134Z] INFO webhook_payload_validated {"provider":"stripe","eventId":"evt_db_error","eventType":"payment_intent.succeeded","correlationId":"5d08d607-cd5a-40f7-86ce-7b100d6fce72"}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:35.139Z] ERROR api_error {"code":"INTERNAL_ERROR","message":"db down","requestId":"5d08d607-cd5a-40f7-86ce-7b100d6fce72","details":[],"name":"Error","stack":"Error: db down\n    at Object.<anonymous> (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\tests\\routes\\webhooks.stripe.branches.test.js:65:52)\n    at Promise.then.completed (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\utils.js:298:28)\n    at new Promise (<anonymous>)\n    at callAsyncCircusFn (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\utils.js:231:10)\n    at _callCircusTest (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:316:40)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at _runTest (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:252:3)\n    at _runTestsForDescribeBlock (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:126:9)\n    at _runTestsForDescribeBlock (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:121:9)\n    at run (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\run.js:71:3)\n    at runAndTransformResultsToJestFormat (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n    at jestAdapter (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n    at runTestInternal (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n    at runTest (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\jest-runner\\build\\runTest.js:444:34)"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at next (node_modules/express/lib/router/route.js:141:14)
      at next (src/routes/webhooks.routes.js:214:12)

  console.error
    [2026-02-18T12:12:35.141Z] ERROR http_request_failed {"requestId":"5d08d607-cd5a-40f7-86ce-7b100d6fce72","method":"POST","path":"/api/webhooks/stripe","status":500,"elapsedMs":8}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at ServerResponse.error (src/middlewares/requestLogger.js:22:14)

PASS tests/routes/webhooks.stripe.branches.test.js (385 MB heap size)
  stripe webhook route branches
    Ã”ÃªÃœ rejects unexpected payment intent status (31 ms)
    Ã”ÃªÃœ propagates unexpected errors to error middleware (16 ms)

  console.warn
    [2026-02-18T12:12:35.409Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"email","message":"email must be a valid email address"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    [2026-02-18T12:12:35.422Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"message","message":"message must contain at least 10 characters"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    [2026-02-18T12:12:35.433Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"name","message":"name must contain at most 120 characters"},{"field":"message","message":"message must contain at most 2000 characters"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.warn
    [2026-02-18T12:12:35.442Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid request payload","details":[{"field":"name","message":"name is required"},{"field":"email","message":"email is required"},{"field":"message","message":"message is required"}],"name":"ValidationError","stack":"ValidationError: Invalid request payload\n    at ValidationError.fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\errors\\validation-error.js:31:12)\n    at fromZodError (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\src\\validation\\validate.middleware.js:32:37)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:284:15\n    at router.process_params (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:214:14)\n    at invokeCallback (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\insid\\Desktop\\VS code project\\inside-home\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:508:28)\n    at endReadableNT (node:internal/streams/readable:1701:12)\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at next (node_modules/express/lib/router/route.js:147:13)
      at next (src/validation/validate.middleware.js:32:16)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

PASS tests/validation/leads.validation.test.js (398 MB heap size)
  Leads validation
    Ã”ÃªÃœ rejects invalid email format (41 ms)
    Ã”ÃªÃœ rejects xss/script payload by min length constraints (10 ms)
    Ã”ÃªÃœ rejects massive payload > limits (10 ms)
    Ã”ÃªÃœ keeps homogeneous JSON error envelope (10 ms)

  console.warn
    [2026-02-18T12:12:35.570Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000002","context":{"repository":"order","operation":"createPendingPaymentOrder"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createPendingPaymentOrder] (src/repositories/order.repository.js:244:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:154:5)

  console.error
    [2026-02-18T12:12:35.589Z] ERROR db_error {"message":"Prisma update failure","context":{"repository":"order","operation":"createPendingPaymentOrder"}}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:36:3)
      at Object.normalizeDbError [as createPendingPaymentOrder] (src/repositories/order.repository.js:244:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:170:5)

  console.warn
    [2026-02-18T12:12:35.592Z] WARN db_error {"message":"Order already paid: order-paid","context":{"repository":"order","operation":"markPaidFromWebhook"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as markPaidFromWebhook] (src/repositories/order.repository.js:293:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:193:5)

  console.warn
    [2026-02-18T12:12:35.594Z] WARN db_error {"message":"Amount mismatch: expected 99900, computed 1000","context":{"repository":"order","operation":"createPendingPaymentOrder"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createPendingPaymentOrder] (src/repositories/order.repository.js:244:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:211:5)

  console.warn
    [2026-02-18T12:12:35.596Z] WARN db_error {"message":"Order not found: does-not-exist","context":{"repository":"order","operation":"markPaidFromWebhook"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as markPaidFromWebhook] (src/repositories/order.repository.js:293:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:227:5)

  console.warn
    [2026-02-18T12:12:35.598Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createPendingPaymentOrder"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createPendingPaymentOrder] (src/repositories/order.repository.js:244:7)
          at async Promise.allSettled (index 1)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:243:29)

  console.error
    [2026-02-18T12:12:35.600Z] ERROR db_error {"message":"Create many failed","context":{"repository":"order","operation":"createPendingPaymentOrder"}}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:36:3)
      at Object.normalizeDbError [as createPendingPaymentOrder] (src/repositories/order.repository.js:244:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:267:5)

  console.error
    [2026-02-18T12:12:35.603Z] ERROR db_error {"message":"db create","context":{"repository":"order","operation":"create"}}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:36:3)
      at Object.normalizeDbError [as create] (src/repositories/order.repository.js:63:73)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:304:5)

  console.warn
    [2026-02-18T12:12:35.612Z] WARN db_error {"message":"Product not found: missing","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:312:5)

  console.warn
    [2026-02-18T12:12:35.615Z] WARN db_error {"message":"Invalid expected total amount","context":{"repository":"order","operation":"createPendingPaymentOrder"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createPendingPaymentOrder] (src/repositories/order.repository.js:244:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:342:5)

  console.warn
    [2026-02-18T12:12:35.617Z] WARN db_error {"message":"Webhook metadata mismatch for order identity/idempotency","context":{"repository":"order","operation":"markPaidFromWebhook"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as markPaidFromWebhook] (src/repositories/order.repository.js:293:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:362:5)

  console.warn
    [2026-02-18T12:12:35.619Z] WARN db_error {"message":"Webhook idempotency key mismatch","context":{"repository":"order","operation":"processPaymentWebhookEvent"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as processPaymentWebhookEvent] (src/repositories/order.repository.js:344:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:406:5)

  console.error
    [2026-02-18T12:12:35.630Z] ERROR db_error {"message":"Order create failed","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:36:3)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:432:5)

  console.error
    [2026-02-18T12:12:35.632Z] ERROR db_error {"message":"Webhook event insert failed","context":{"repository":"order","operation":"markPaidFromWebhook"}}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:36:3)
      at Object.normalizeDbError [as markPaidFromWebhook] (src/repositories/order.repository.js:293:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:439:5)

  console.error
    [2026-02-18T12:12:35.633Z] ERROR db_error {"message":"Webhook event insert failed","context":{"repository":"order","operation":"processPaymentWebhookEvent"}}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:36:3)
      at Object.normalizeDbError [as processPaymentWebhookEvent] (src/repositories/order.repository.js:344:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:449:5)

  console.warn
    [2026-02-18T12:12:35.635Z] WARN db_error {"message":"Product not found: missing","context":{"repository":"order","operation":"createPendingPaymentOrder"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createPendingPaymentOrder] (src/repositories/order.repository.js:244:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:461:5)

  console.error
    [2026-02-18T12:12:35.636Z] ERROR db_error {"message":"Order create failed","context":{"repository":"order","operation":"createPendingPaymentOrder"}}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:36:3)
      at Object.normalizeDbError [as createPendingPaymentOrder] (src/repositories/order.repository.js:244:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:469:5)

  console.warn
    [2026-02-18T12:12:35.637Z] WARN db_error {"message":"Order already paid: order-paid-process","context":{"repository":"order","operation":"processPaymentWebhookEvent"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as processPaymentWebhookEvent] (src/repositories/order.repository.js:344:7)
      at Object.<anonymous> (tests/repositories/order.repository.transaction.test.js:490:5)

PASS tests/repositories/order.repository.transaction.test.js (391 MB heap size)
  orderRepository transactional guards
    Ã”ÃªÃœ Cas 1 Ã”Ã‡Ã¶ succâ”œÂ¿s complet: crâ”œÂ®e la commande, dâ”œÂ®crâ”œÂ®mente le stock et commit (4 ms)
    Ã”ÃªÃœ Cas 2 Ã”Ã‡Ã¶ stock insuffisant: rollback complet (18 ms)
    Ã”ÃªÃœ Cas 3 Ã”Ã‡Ã¶ erreur DB pendant update: transaction annulâ”œÂ®e (3 ms)
    Ã”ÃªÃœ Cas 4 Ã”Ã‡Ã¶ double paiement: refus explicite et aucune modification (2 ms)
    Ã”ÃªÃœ Cas 5 Ã”Ã‡Ã¶ montant incohâ”œÂ®rent: rejet immâ”œÂ®diat (2 ms)
    Ã”ÃªÃœ Cas 6 Ã”Ã‡Ã¶ commande inexistante: erreur propre sans crash (2 ms)
    Ã”ÃªÃœ Cas 7 Ã”Ã‡Ã¶ concurrence simulâ”œÂ®e: pas de double dâ”œÂ®crâ”œÂ®ment (2 ms)
    Ã”ÃªÃœ Cas 8 Ã”Ã‡Ã¶ erreur intermâ”œÂ®diaire multi-â”œÂ®tapes: rollback strict (2 ms)
  orderRepository additional branch coverage
    Ã”ÃªÃœ CRUD wrappers call prisma and normalize db errors (2 ms)
    Ã”ÃªÃœ createIdempotentWithItemsAndUpdateStock handles product not found and replay (10 ms)
    Ã”ÃªÃœ createPendingPaymentOrder replay P2002 and invalid expected amount (2 ms)
    Ã”ÃªÃœ markPaidFromWebhook handles replay and metadata mismatch (2 ms)
    Ã”ÃªÃœ processPaymentWebhookEvent covers replay, mismatch and paymentIntent path (2 ms)
    Ã”ÃªÃœ non-P2002 errors inside transactions are propagated via normalizeDbError (14 ms)
    Ã”ÃªÃœ createPendingPaymentOrder product missing and generic create error are handled (3 ms)
    Ã”ÃªÃœ processPaymentWebhookEvent rejects already paid order when metadata provided (1 ms)
    Ã”ÃªÃœ list default params and processPaymentWebhookEvent orderId path are covered (1 ms)
    Ã”ÃªÃœ default parameter paths for webhook handlers are executed

  console.warn
    [2026-02-18T12:12:35.769Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 5)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.771Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 6)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.771Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 7)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.772Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 8)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.773Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 9)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.773Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 10)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.774Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 11)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.775Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 12)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.775Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 13)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.776Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 14)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.777Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 15)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.777Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 16)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.778Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 17)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.779Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 18)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.779Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 19)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.780Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 20)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.781Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 21)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.781Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 22)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.782Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 23)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.783Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 24)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.783Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 25)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.784Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 26)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.785Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 27)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.785Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 28)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.786Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 29)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.787Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 30)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.788Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 31)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.788Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 32)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.789Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 33)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.790Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 34)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.790Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 35)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.791Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 36)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.792Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 37)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.792Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 38)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.793Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 39)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.794Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 40)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.794Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 41)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.795Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 42)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.796Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 43)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.796Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 44)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.797Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 45)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.797Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 46)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.798Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 47)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.799Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 48)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.799Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
          at async Promise.allSettled (index 49)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:151:21)

  console.warn
    [2026-02-18T12:12:35.802Z] WARN db_error {"message":"Insufficient stock for product: 00000000-0000-0000-0000-000000000002","context":{"repository":"order","operation":"createIdempotentWithItemsAndUpdateStock"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createIdempotentWithItemsAndUpdateStock] (src/repositories/order.repository.js:157:7)
      at Object.<anonymous> (tests/integration/order.repository.fintech-audit.test.js:165:5)

PASS tests/integration/order.repository.fintech-audit.test.js (433 MB heap size)
  Order repository fintech audit
    Ã”ÃªÃœ idempotency replay returns existing order and does not duplicate stock decrement (3 ms)
    Ã”ÃªÃœ oversell under contention never decrements below zero and rejects extra orders (34 ms)
    Ã”ÃªÃœ multi-item stock failure rolls back entire transaction (12 ms)
    Ã”ÃªÃœ webhook replay is a no-op and order paid status is set once (2 ms)

  console.error
    [2026-02-18T12:12:35.940Z] ERROR rate_limit_backend_down {"level":"error","event":"rate_limit_backend_down"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/middlewares/rateLimit.js:91:14)
      at Object.<anonymous> (tests/middlewares/rateLimit.helpers.test.js:66:5)

PASS tests/middlewares/rateLimit.helpers.test.js (409 MB heap size)
  rateLimit helpers
    Ã”ÃªÃœ resolveClientIp handles direct ipv4 mapping (2 ms)
    Ã”ÃªÃœ resolveClientIp validates trusted x-forwarded-for (1 ms)
    Ã”ÃªÃœ resolveClientIp rejects malformed x-forwarded-for (11 ms)
    Ã”ÃªÃœ resolveClientIp rejects unresolved ip (1 ms)
    Ã”ÃªÃœ endpoint token defaults to root (1 ms)
    Ã”ÃªÃœ middleware returns 503 when backend fails (3 ms)
    Ã”ÃªÃœ resolveClientIp rejects spoofing when proxy is not trusted (1 ms)
    Ã”ÃªÃœ apiRateLimiter builds endpoint+ip key and enforces limits (1 ms)
    Ã”ÃªÃœ authRateLimiter re-exports strict limiter (1 ms)
    Ã”ÃªÃœ resolveClientIp rejects when ip fields are absent (1 ms)
    Ã”ÃªÃœ endpoint token can use originalUrl fallback (1 ms)
    Ã”ÃªÃœ limiter works when response has no setHeader function (1 ms)

PASS tests/middlewares/authRateLimiter.attack.test.js (423 MB heap size)
  authRateLimiter attack scenarios
    Ã”ÃªÃœ 1 to 4 attempts are allowed (3 ms)
    Ã”ÃªÃœ 5th attempt is blocked (2 ms)
    Ã”ÃªÃœ attempt remains blocked in same window (1 ms)
    Ã”ÃªÃœ counter resets after ttl (67 ms)

  console.log
    [2026-02-18T12:12:36.226Z] INFO redis_connected {"attempt":1}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:36.229Z] WARN redis_connect_failed {"attempt":1,"message":"boom"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at Object.warn [as connect] (src/lib/simple-redis-client.js:85:16)
      at Object.<anonymous> (tests/lib/simple-redis.resilience.test.js:38:5)

  console.warn
    [2026-02-18T12:12:36.247Z] WARN redis_connect_failed {"attempt":2,"message":"boom"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at Object.warn [as connect] (src/lib/simple-redis-client.js:85:16)
      at Object.<anonymous> (tests/lib/simple-redis.resilience.test.js:38:5)

  console.warn
    [2026-02-18T12:12:36.277Z] WARN redis_connect_failed {"attempt":1,"message":"Redis connection timeout after 5ms"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at Object.warn [as connect] (src/lib/simple-redis-client.js:85:16)
      at Object.<anonymous> (tests/lib/simple-redis.resilience.test.js:50:5)

  console.log
    [2026-02-18T12:12:36.279Z] INFO redis_reconnecting {"attempt":2}

      at log (src/utils/logger.js:44:11)

  console.error
    [2026-02-18T12:12:36.280Z] ERROR redis_error {"message":"network"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/lib/simple-redis-client.js:62:12)
      at Object.emit (tests/lib/simple-redis.resilience.test.js:13:26)
      at Object.emit (tests/lib/simple-redis.resilience.test.js:59:16)

  console.log
    [2026-02-18T12:12:36.284Z] INFO redis_connected {"attempt":1}

      at log (src/utils/logger.js:44:11)

  console.log
    [2026-02-18T12:12:36.285Z] INFO redis_quit {}

      at log (src/utils/logger.js:44:11)

  console.warn
    [2026-02-18T12:12:36.289Z] WARN redis_connect_failed {"attempt":1,"message":"down"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at Object.warn [as connect] (src/lib/simple-redis-client.js:85:16)
      at Object.<anonymous> (tests/lib/simple-redis.resilience.test.js:89:3)

  console.error
    [2026-02-18T12:12:36.291Z] ERROR redis_quit_failed {"message":"quit failed"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at Object.error [as quit] (src/lib/simple-redis-client.js:104:14)
      at Object.<anonymous> (tests/lib/simple-redis.resilience.test.js:96:3)

PASS tests/lib/simple-redis.resilience.test.js (444 MB heap size)
  Ã”ÃªÃœ throws when createClient is missing (3 ms)
  Ã”ÃªÃœ returns null when optional redis cannot connect (1 ms)
  Ã”ÃªÃœ quit surfaces errors (2 ms)
  simple-redis-client resilience
    Ã”ÃªÃœ connects successfully (5 ms)
    Ã”ÃªÃœ fails when required and connection cannot be established (27 ms)
    Ã”ÃªÃœ times out long connection attempts (24 ms)
    Ã”ÃªÃœ emits reconnecting and error events (4 ms)
    Ã”ÃªÃœ quits gracefully (2 ms)

  console.error
    [2026-02-18T12:12:36.454Z] ERROR rate_limit_backend_down {"event":"rate_limit_backend_down","key":"rate:auth:9.9.9.9","message":"down"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at Object.error [as increment] (src/lib/rate-limit-redis-store.js:47:14)
      at Object.<anonymous> (tests/lib/rate-limit-redis-store.atomic.test.js:84:5)

  console.error
    [2026-02-18T12:12:36.461Z] ERROR rate_limit_backend_down {"event":"rate_limit_backend_down","key":"rate:auth:none","message":"Redis client unavailable"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at Object.error [as increment] (src/lib/rate-limit-redis-store.js:26:14)
      at Object.increment (tests/lib/rate-limit-redis-store.atomic.test.js:89:24)

PASS tests/lib/rate-limit-redis-store.atomic.test.js (420 MB heap size)
  rate-limit redis store atomicity
    Ã”ÃªÃœ first request initializes counter and ttl (2 ms)
    Ã”ÃªÃœ second request increments same key (1 ms)
    Ã”ÃªÃœ ttl expiration resets counter (38 ms)
    Ã”ÃªÃœ different keys do not collide (1 ms)
    Ã”ÃªÃœ concurrent increments stay atomic (1 ms)
    Ã”ÃªÃœ redis unavailable throws (8 ms)
    Ã”ÃªÃœ missing redis client throws (1 ms)
    Ã”ÃªÃœ constructor rejects missing getter (2 ms)

  console.error
    [BOOT_FATAL] Infrastructure unavailable: Redis client unavailable

    [0m [90m 54 |[39m       dependencies[33m:[39m [[32m'redis'[39m[33m,[39m [32m'database'[39m[33m,[39m [32m'jwt'[39m[33m,[39m [32m'stripe'[39m[33m,[39m [32m'paypal'[39m][33m,[39m
     [90m 55 |[39m     })[33m;[39m
    [31m[1m>[22m[39m[90m 56 |[39m     console[33m.[39merror([32m`[BOOT_FATAL] Infrastructure unavailable: ${message}`[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 57 |[39m     exit([35m1[39m)[33m;[39m
     [90m 58 |[39m     [36mreturn[39m { ok[33m:[39m [36mfalse[39m }[33m;[39m
     [90m 59 |[39m   }[0m

      at error (src/config/boot-infrastructure.js:56:13)
      at Object.<anonymous> (tests/config/boot-infrastructure.test.js:9:20)

  console.error
    [BOOT_FATAL] Infrastructure unavailable: db down

    [0m [90m 54 |[39m       dependencies[33m:[39m [[32m'redis'[39m[33m,[39m [32m'database'[39m[33m,[39m [32m'jwt'[39m[33m,[39m [32m'stripe'[39m[33m,[39m [32m'paypal'[39m][33m,[39m
     [90m 55 |[39m     })[33m;[39m
    [31m[1m>[22m[39m[90m 56 |[39m     console[33m.[39merror([32m`[BOOT_FATAL] Infrastructure unavailable: ${message}`[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 57 |[39m     exit([35m1[39m)[33m;[39m
     [90m 58 |[39m     [36mreturn[39m { ok[33m:[39m [36mfalse[39m }[33m;[39m
     [90m 59 |[39m   }[0m

      at error (src/config/boot-infrastructure.js:56:13)
      at Object.<anonymous> (tests/config/boot-infrastructure.test.js:29:20)

PASS tests/config/boot-infrastructure.test.js (438 MB heap size)
  boot infrastructure hardening
    Ã”ÃªÃœ exits in production when redis is unavailable (4 ms)
    Ã”ÃªÃœ exits in production when database connection fails (1 ms)
    Ã”ÃªÃœ does not exit outside production (1 ms)

PASS tests/security/jwt.edgecases.test.js (456 MB heap size)
  JWT edge cases
    Ã”ÃªÃœ accepts valid token (3 ms)
    Ã”ÃªÃœ rejects expired token (1 ms)
    Ã”ÃªÃœ rejects invalid signature (1 ms)
    Ã”ÃªÃœ rejects invalid algorithm
    Ã”ÃªÃœ rejects audience mismatch (1 ms)
    Ã”ÃªÃœ rejects issuer mismatch (1 ms)
    Ã”ÃªÃœ rejects malformed token (1 ms)
    Ã”ÃªÃœ returns misconfigured when secret absent

  console.warn
    [2026-02-18T12:12:36.853Z] WARN auth_failure {"reason":"token verification error","detail":"Invalid access token","requestId":"req-1"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/middlewares/authenticate.js:13:10)
      at logAuthenticationFailure (src/middlewares/authenticate.js:47:5)
      at Object.authenticate (tests/security/auth.middlewares.coverage.test.js:39:5)

  console.warn
    [2026-02-18T12:12:36.856Z] WARN auth_failure {"reason":"token payload missing subject"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at warn (src/middlewares/authenticate.js:13:10)
      at logAuthenticationFailure (src/middlewares/authenticate.js:57:5)
      at Object.authenticate (tests/security/auth.middlewares.coverage.test.js:51:5)

PASS tests/security/auth.middlewares.coverage.test.js (439 MB heap size)
  auth middleware branch coverage
    Ã”ÃªÃœ authenticate rejects missing and malformed authorization header (2 ms)
    Ã”ÃªÃœ authenticate rejects invalid and missing subject tokens (5 ms)
    Ã”ÃªÃœ authenticate sets normalized user on success (2 ms)
    Ã”ÃªÃœ authorizeRole validates arguments and enforces role (7 ms)
    Ã”ÃªÃœ rbac helpers and requirePermission enforce permissions (2 ms)

PASS tests/middlewares/rateLimit.enforcement.test.js (453 MB heap size)
  rate limit middleware enforcement
    Ã”ÃªÃœ allows request under limit (2 ms)
    Ã”ÃªÃœ blocks request with 429 when limit exceeded (1 ms)
    Ã”ÃªÃœ resets after ttl (36 ms)
    Ã”ÃªÃœ rejects ip spoofing when proxy is not trusted (1 ms)
    Ã”ÃªÃœ rejects malformed forwarded header when trust proxy is enabled (1 ms)

  console.warn
    [2026-02-18T12:12:37.129Z] WARN db_error {"message":"Order already paid: ord-1","context":{"repository":"order","operation":"markPaidFromWebhook"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as markPaidFromWebhook] (src/repositories/order.repository.js:293:7)
      at Object.<anonymous> (tests/integration/order.transaction.integration.test.js:147:5)

  console.warn
    [2026-02-18T12:12:37.132Z] WARN db_error {"message":"Insufficient stock for product: 10000000-0000-0000-0000-000000000001","context":{"repository":"order","operation":"createPendingPaymentOrder"}}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at logDbError (src/lib/db-error.js:4:16)
      at logDbError (src/lib/db-error.js:14:5)
      at Object.normalizeDbError [as createPendingPaymentOrder] (src/repositories/order.repository.js:244:7)
          at async Promise.allSettled (index 1)
      at Object.<anonymous> (tests/integration/order.transaction.integration.test.js:161:21)

PASS tests/integration/order.transaction.integration.test.js (474 MB heap size)
  order transaction integration (isolated in-memory DB)
    Ã”ÃªÃœ crâ”œÂ®e une commande râ”œÂ®elle et met â”œÃ¡ jour le stock (4 ms)
    Ã”ÃªÃœ refuse une tentative de double paiement (4 ms)
    Ã”ÃªÃœ charge concurrente simple: protâ”œÂ¿ge le stock (2 ms)

  console.error
    [2026-02-18T12:12:37.255Z] ERROR boot_config_invalid {"errors":["JWT_ACCESS_SECRET is required","STRIPE_SECRET is required","PAYPAL_SECRET is required"]}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/config/boot-validation.js:94:10)
      at Object.assertProductionBootConfigOrExit (tests/config/boot-validation.test.js:91:5)

  console.error
    [2026-02-18T12:12:37.258Z] ERROR boot_config_invalid {"errors":["JWT_REFRESH_SECRET is required","STRIPE_SECRET is required","PAYPAL_SECRET is required"]}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at error (src/config/boot-validation.js:94:10)
      at Object.assertProductionBootConfigOrExit (tests/config/boot-validation.test.js:115:5)

PASS tests/config/boot-validation.test.js (452 MB heap size)
  boot configuration validation
    Ã”ÃªÃœ validateBootConfig reports missing required production settings (2 ms)
    Ã”ÃªÃœ validateBootConfig enforces minimum JWT secret length
    Ã”ÃªÃœ assertProductionBootConfigOrExit fails fast in production (2 ms)
    Ã”ÃªÃœ assertProductionBootConfigOrExit exits when JWT_ACCESS_SECRET is missing in production (2 ms)
    Ã”ÃªÃœ assertProductionBootConfigOrExit exits when JWT_REFRESH_SECRET is missing in production (1 ms)
    Ã”ÃªÃœ assertProductionBootConfigOrExit does not exit outside production (1 ms)

PASS tests/admin-ui-visibility.e2e.test.js (468 MB heap size)
  E2E UI visibility - admin menu/actions by role
    Ã”ÃªÃœ non-authenticated user: no admin menu, no admin actions, admin route visually guarded (3 ms)
    Ã”ÃªÃœ customer user: no admin menu, no admin actions, admin route visually guarded (1 ms)
    Ã”ÃªÃœ admin user: admin menu and actions are visible/enabled (1 ms)
    Ã”ÃªÃœ guest identity is always blocked from admin UI even if role payload is tampered (1 ms)
    Ã”ÃªÃœ loading state: fail-closed (admin remains hidden until role confirmed) (1 ms)

PASS tests/guest-checkout.frontend.unit.test.js (482 MB heap size)
  guest checkout frontend api helpers
    Ã”ÃªÃœ builds strict checkout payload + idempotency key (2 ms)
    Ã”ÃªÃœ stores guest jwt session emitted by backend (1 ms)
    Ã”ÃªÃœ creates payment intent with bearer token (1 ms)
    Ã”ÃªÃœ confirms stripe payment through sdk when available

PASS tests/lib/stripe.security.test.js (455 MB heap size)
  stripe webhook security
    Ã”ÃªÃœ accepts valid signature (2 ms)
    Ã”ÃªÃœ rejects invalid signature (7 ms)
    Ã”ÃªÃœ rejects missing signature header (1 ms)
    Ã”ÃªÃœ rejects expired timestamp (1 ms)
    Ã”ÃªÃœ rejects malformed payload (1 ms)
    Ã”ÃªÃœ rejects payload that is not a buffer (1 ms)
    Ã”ÃªÃœ rejects missing webhook secret
    Ã”ÃªÃœ rejects missing v1 signature value
    Ã”ÃªÃœ rejects invalid signature timestamp format (1 ms)
    Ã”ÃªÃœ passes unsupported event type through signature construction for route-level filtering (1 ms)

PASS tests/validation/strict-validate.middleware.test.js (473 MB heap size)
  strictValidate middleware
    Ã”ÃªÃœ throws for unsupported property selector (8 ms)
    Ã”ÃªÃœ parses valid payload and calls next for body (2 ms)
    Ã”ÃªÃœ returns 400 for unknown field injection (2 ms)
    Ã”ÃªÃœ returns 400 for empty body when required field is missing (1 ms)
    Ã”ÃªÃœ returns 400 for malformed payload type (array instead of object)
    Ã”ÃªÃœ returns 400 for null vs required object payload (1 ms)
    Ã”ÃªÃœ parses params payload when property is params (1 ms)
    Ã”ÃªÃœ forwards unexpected parser errors via next(error) (1 ms)

  console.warn
    [2026-02-18T12:12:37.820Z] WARN api_error {"code":"VALIDATION_ERROR","message":"Invalid payload","requestId":"req-1","details":[{"path":["email"],"message":"Invalid email"}],"name":"AppError"}

    [0m [90m 38 |[39m
     [90m 39 |[39m   [36mif[39m (level [33m===[39m [32m'warn'[39m) {
    [31m[1m>[22m[39m[90m 40 |[39m     console[33m.[39mwarn(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 41 |[39m     [36mreturn[39m[33m;[39m
     [90m 42 |[39m   }
     [90m 43 |[39m[0m

      at warn (src/utils/logger.js:40:13)
      at Object.emit (src/utils/logger.js:55:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Object.errorHandler (tests/middlewares/error-handler.production.test.js:37:5)

  console.error
    [2026-02-18T12:12:37.824Z] ERROR api_error {"code":"INTERNAL_ERROR","message":"Internal server error","requestId":"req-2","details":[],"name":"Error"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Object.errorHandler (tests/middlewares/error-handler.production.test.js:58:5)

  console.error
    [2026-02-18T12:12:37.826Z] ERROR api_error {"code":"INTERNAL_ERROR","message":"detailed failure","details":[],"name":"Error","stack":"dev-stack"}

    [0m [90m 33 |[39m
     [90m 34 |[39m   [36mif[39m (level [33m===[39m [32m'error'[39m) {
    [31m[1m>[22m[39m[90m 35 |[39m     console[33m.[39merror(line)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 36 |[39m     [36mreturn[39m[33m;[39m
     [90m 37 |[39m   }
     [90m 38 |[39m[0m

      at error (src/utils/logger.js:35:13)
      at Object.emit [as error] (src/utils/logger.js:58:5)
      at errorHandler (src/middlewares/error-handler.js:55:16)
      at Object.errorHandler (tests/middlewares/error-handler.production.test.js:74:5)

PASS tests/middlewares/error-handler.production.test.js (488 MB heap size)
  error handler production masking
    Ã”ÃªÃœ returns AppError message as-is in production (4 ms)
    Ã”ÃªÃœ masks non-AppError 5xx message in production and omits stack (1 ms)
    Ã”ÃªÃœ keeps non-AppError 5xx message in development for debugging (2 ms)

PASS tests/middlewares/checkout-customer-access.test.js (503 MB heap size)
  checkoutCustomerAccess policy
    Ã”ÃªÃœ allows normalized customer role with non-guest identity (2 ms)
    Ã”ÃªÃœ allows guest identity only with guest role + guest flag
    Ã”ÃªÃœ rejects anonymous request with 401 (1 ms)
    Ã”ÃªÃœ rejects admin role with 403 (1 ms)
    Ã”ÃªÃœ rejects tampered guest claims with 403 (1 ms)

PASS tests/validation/orders-schema.hardening.test.js (482 MB heap size)
  orders schema hardening
    Ã”ÃªÃœ create schema accepts valid payload (3 ms)
    Ã”ÃªÃœ create schema rejects payload with invalid field types (1 ms)
    Ã”ÃªÃœ create schema rejects unknown fields in strict mode (1 ms)
    Ã”ÃªÃœ create schema rejects client-provided userId
    Ã”ÃªÃœ create schema rejects missing idempotencyKey
    Ã”ÃªÃœ payment webhook schema accepts orderId-based payload (1 ms)
    Ã”ÃªÃœ payment webhook schema accepts stripePaymentIntentId-based payload (1 ms)
    Ã”ÃªÃœ payment webhook schema rejects when both orderId and stripePaymentIntentId are missing (1 ms)
    Ã”ÃªÃœ payment webhook schema rejects unknown field in strict mode
    Ã”ÃªÃœ byId params schema accepts valid UUID and rejects unknown field (1 ms)

PASS tests/lib/paypal.security.test.js (501 MB heap size)
  paypal webhook security
    Ã”ÃªÃœ verification success (3 ms)
    Ã”ÃªÃœ verification fail (1 ms)
    Ã”ÃªÃœ api token error (6 ms)
    Ã”ÃªÃœ invalid access token payload (1 ms)
    Ã”ÃªÃœ missing env throws (2 ms)
    Ã”ÃªÃœ verification endpoint error returns explicit reason (1 ms)
    Ã”ÃªÃœ unknown verification status is returned (1 ms)
    Ã”ÃªÃœ missing headers returns non-verified (1 ms)

PASS tests/integration/postgres.integration.test.js (512 MB heap size)
  PostgreSQL integration (EPIC-1.4)
    Ã”ÃªÃœ database precondition is explicit when PostgreSQL is unavailable (2 ms)

PASS tests/middlewares/checkout-order-ownership.test.js (526 MB heap size)
  enforceOrderOwnership middleware
    Ã”ÃªÃœ rejects anonymous request with 401 (2 ms)
    Ã”ÃªÃœ rejects client-provided userId with 400 (1 ms)
    Ã”ÃªÃœ allows payload without userId and relies on auth.sub binding

PASS tests/utils/minor-units.test.js (498 MB heap size)
  minor units financial normalization
    Ã”ÃªÃœ handles 0.1 + 0.2 without float drift (2 ms)
    Ã”ÃªÃœ applies deterministic rounding (1 ms)
    Ã”ÃªÃœ supports multiple currency exponents (1 ms)
    Ã”ÃªÃœ rejects invalid amount formats (8 ms)

PASS tests/structure/logout-mount-order.test.js (510 MB heap size)
  logout mount and override guard
    Ã”ÃªÃœ does not define logout route outside auth router (3 ms)
    Ã”ÃªÃœ mounts auth router before other /api routers in app (1 ms)

PASS tests/structure/logout-route.uniqueness.test.js (522 MB heap size)
  logout route uniqueness guard
    Ã”ÃªÃœ defines exactly one POST /logout across all route files (3 ms)
    Ã”ÃªÃœ mounts auth router exactly once (1 ms)

PASS tests/security/refresh-token-store.redis.test.js (535 MB heap size)
  refresh token store redis strict semantics
    Ã”ÃªÃœ uses SET NX and rejects overwrite for same refresh:<tokenId> key (2 ms)
    Ã”ÃªÃœ rotation atomically deletes old and writes new session (1 ms)

--------------------------------|---------|----------|---------|---------|------------------------------
File                            | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s            
--------------------------------|---------|----------|---------|---------|------------------------------
All files                       |   80.89 |     76.1 |   76.12 |   83.94 |                              
 src                            |     100 |      100 |     100 |     100 |                              
  app.js                        |     100 |      100 |     100 |     100 |                              
 src/config                     |   87.14 |    66.66 |    90.9 |   87.87 |                              
  boot-infrastructure.js        |   73.91 |    42.85 |      75 |   73.91 | 14-24,42,48                  
  boot-validation.js            |   93.61 |    79.48 |     100 |   95.34 | 28,73                        
 src/errors                     |   72.22 |    29.16 |   55.55 |   70.58 |                              
  app-error.js                  |   55.55 |     6.66 |      20 |   55.55 | 18-36                        
  validation-error.js           |   88.88 |    66.66 |     100 |    87.5 | 23                           
 src/lib                        |   78.71 |     68.3 |   72.13 |   78.68 |                              
  db-error.js                   |   52.38 |       70 |     100 |   52.38 | 19-24,28-33                  
  paypal.js                     |     100 |      100 |     100 |     100 |                              
  prisma.js                     |   47.22 |     42.3 |   33.33 |   48.57 | 8,10-16,18,23,27,41-50,60    
  rate-limit-redis-store.js     |     100 |    73.33 |     100 |     100 | 39-60                        
  refresh-token-redis-client.js |    5.26 |        0 |       0 |    5.26 | 6-42                         
  simple-redis-client.js        |      98 |       90 |     100 |   97.95 | 95                           
  stripe.js                     |   97.56 |    90.62 |     100 |   97.43 | 56                           
  webhook-idempotency-store.js  |    82.6 |       70 |     100 |    82.6 | 14,37,43-44                  
 src/middlewares                |      93 |    89.89 |   97.95 |    93.1 |                              
  authRateLimiter.js            |     100 |      100 |     100 |     100 |                              
  authenticate.js               |   96.15 |    94.44 |     100 |   96.15 | 38                           
  authorizeRole.js              |    92.3 |    92.85 |     100 |    90.9 | 22                           
  checkoutCustomerAccess.js     |     100 |       90 |     100 |     100 | 38                           
  checkoutIdentity.js           |   83.33 |    83.33 |     100 |   83.33 | 17,26                        
  cookieParser.js               |   86.66 |       75 |     100 |   92.85 | 5                            
  cors.js                       |   71.42 |    70.58 |     100 |      70 | 12,20,25,29-30,38            
  error-handler.js              |   96.66 |     87.8 |     100 |   96.55 | 12                           
  rateLimit.js                  |   95.08 |    96.07 |   94.11 |   94.82 | 13,25,66                     
  rbac.js                       |   91.66 |       90 |     100 |   91.66 | 22                           
  requestContext.js             |     100 |      100 |     100 |     100 |                              
  requestLogger.js              |     100 |      100 |     100 |     100 |                              
  requirePermission.js          |     100 |    91.66 |     100 |     100 | 10                           
  securityHeaders.js            |     100 |      100 |     100 |     100 |                              
 src/repositories               |   54.34 |       61 |      50 |   62.67 |                              
  analytics.repository.js       |       0 |        0 |       0 |       0 | 4-19                         
  cart.repository.js            |       0 |        0 |       0 |       0 | 4-30                         
  lead.repository.js            |       0 |        0 |       0 |       0 | 4-19                         
  order.repository.js           |   91.97 |     88.4 |     100 |   93.75 | 19-30                        
  product.repository.js         |       0 |        0 |       0 |       0 | 4-19                         
  user.repository.js            |    2.32 |        0 |       0 |    2.38 | 5-29,34-102                  
 src/routes                     |   89.16 |    82.42 |   72.09 |   92.16 |                              
  admin-example.routes.js       |      80 |      100 |      50 |      80 | 9                            
  admin-routes.js               |     100 |      100 |     100 |     100 |                              
  analytics.routes.js           |      80 |      100 |      50 |     100 |                              
  auth.routes.js                |   90.12 |    84.09 |     100 |   90.12 | 60,71,89,112,165,177,191,213 
  cart.routes.js                |   55.55 |      100 |       0 |     100 |                              
  leads.routes.js               |      60 |      100 |       0 |     100 |                              
  orders.routes.js              |   57.89 |       60 |   33.33 |   61.11 | 49-58                        
  payments.routes.js            |     100 |    83.33 |     100 |     100 | 17,59                        
  products.routes.js            |   71.42 |      100 |   33.33 |     100 |                              
  webhooks.routes.js            |   95.96 |    83.83 |     100 |    95.9 | 34-36,225,293                
 src/security                   |   83.89 |    75.21 |    90.9 |   84.17 |                              
  access-token.js               |   57.89 |       75 |     100 |   57.89 | 8-11,15-18                   
  jwt-config.js                 |     100 |     91.3 |     100 |     100 | 41-45                        
  rbac-policy.js                |   76.92 |    58.33 |     100 |   76.92 | 15,25,33                     
  refresh-token-store.js        |   84.31 |    62.96 |   81.25 |   84.31 | 94,123-128,135,165,192,202   
  refresh-token.js              |   76.47 |    68.42 |     100 |   86.66 | 26,31                        
  token-verifier.js             |   91.66 |    93.75 |     100 |   91.66 | 25                           
 src/utils                      |   84.41 |    77.08 |   92.85 |   86.66 |                              
  api-error.js                  |     100 |      100 |     100 |     100 |                              
  logger.js                     |   84.61 |    64.28 |     100 |   91.66 | 10,26                        
  minor-units.js                |      84 |    82.35 |      80 |      84 | 11-13,57-59,86-87            
 src/validation                 |     100 |    95.65 |     100 |     100 |                              
  strict-validate.middleware.js |     100 |      100 |     100 |     100 |                              
  validate.middleware.js        |     100 |    94.44 |     100 |     100 | 18                           
 src/validation/schemas         |     100 |      100 |     100 |     100 |                              
  analytics.schema.js           |     100 |      100 |     100 |     100 |                              
  auth.schema.js                |     100 |      100 |     100 |     100 |                              
  cart.schema.js                |     100 |      100 |     100 |     100 |                              
  checkout.schema.js            |     100 |      100 |     100 |     100 |                              
  common.schema.js              |       0 |        0 |       0 |       0 |                              
  index.js                      |       0 |        0 |       0 |       0 |                              
  leads.schema.js               |     100 |      100 |     100 |     100 |                              
  orders.schema.js              |     100 |      100 |     100 |     100 |                              
  payments.schema.js            |     100 |      100 |     100 |     100 |                              
  products.schema.js            |     100 |      100 |     100 |     100 |                              
--------------------------------|---------|----------|---------|---------|------------------------------
Jest: "global" coverage threshold for statements (95%) not met: 80.89%
Jest: "global" coverage threshold for branches (90%) not met: 76.1%
Test Suites: 54 passed, 54 total
Tests:       335 passed, 335 total
Snapshots:   0 total
Time:        15.52 s, estimated 18 s
Ran all test suites.
